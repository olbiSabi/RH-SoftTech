{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation RH - Congés et Absences</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/logo/Onian-EasyM.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/absence.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/dossier_individuel_base.css' %}">
</head>
<body>
{% include 'base/header.html' %}

<div class="content">
    <div class="content-header">
        <div class="employee-info">
            <div><h1><i class="fas fa-user-check"></i> Validation RH - Congés et Absences</h1></div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-cards">
        <div class="stat-card validation">
            <i class="fas fa-hourglass-half"></i>
            <h3>Validation Finale</h3>
            <div class="number">{{ stats.validation_rh }}</div>
        </div>
        <div class="stat-card validees">
            <i class="fas fa-check-double"></i>
            <h3>Validées Total</h3>
            <div class="number">{{ stats.validees }}</div>
        </div>
        <div class="stat-card refusees">
            <i class="fas fa-times-circle"></i>
            <h3>Refusées Total</h3>
            <div class="number">{{ stats.refusees }}</div>
        </div>
        <div class="stat-card total">
            <i class="fas fa-calendar-check"></i>
            <h3>Demandes Total</h3>
            <div class="number">{{ stats.total }}</div>
        </div>
        <div class="stat-card absents">
            <i class="fas fa-users"></i>
            <h3>Employés Absents</h3>
            <div class="number">{{ stats.absents_today }}</div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters-section">
        <form method="get" action="" id="filterForm">
            <input type="hidden" name="onglet" value="{{ onglet_actif }}">
            <div class="filters">
                <div class="filter-group">
                    <label>Employé</label>
                    <input type="text" name="employe" value="{{ filtre_employe }}" placeholder="Matricule, nom ou prénom..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div class="filter-group">
                    <label>Département</label>
                    <select name="departement" id="filterDepartement">
                        <option value="">Tous</option>
                        {% for dept in departements %}
                        <option value="{{ dept.id }}" {% if filtre_departement == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.LIBELLE }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select name="type" id="filterType">
                        <option value="">Tous</option>
                        {% for type in types_absence %}
                        <option value="{{ type.id }}" {% if filtre_type == type.id|stringformat:"s" %}selected{% endif %}>{{ type.LIBELLE }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Filtrer</button>
                    <button type="button" class="btn btn-secondary" onclick="resetFilters()"><i class="fas fa-redo"></i> Réinitialiser</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Onglets -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-button {% if onglet_actif == 'a_valider_rh' %}active{% endif %}" onclick="changeTab('a_valider_rh')">
                <i class="fas fa-hourglass-half"></i> À valider RH <span class="tab-badge">{{ count_a_valider_rh }}</span>
            </button>
            <button class="tab-button {% if onglet_actif == 'en_attente' %}active{% endif %}" onclick="changeTab('en_attente')">
                <i class="fas fa-clock"></i> En Attente <span class="tab-badge">{{ count_en_attente }}</span>
            </button>
            <button class="tab-button {% if onglet_actif == 'validees_rh' %}active{% endif %}" onclick="changeTab('validees_rh')">
                <i class="fas fa-check-circle"></i> Validées <span class="tab-badge">{{ count_validees_rh }}</span>
            </button>
            <button class="tab-button {% if onglet_actif == 'refusees_manager' %}active{% endif %}" onclick="changeTab('refusees_manager')">
                <i class="fas fa-user-times"></i> Refus Manager <span class="tab-badge">{{ count_refusees_manager }}</span>
            </button>
            <button class="tab-button {% if onglet_actif == 'refusees_rh' %}active{% endif %}" onclick="changeTab('refusees_rh')">
                <i class="fas fa-ban"></i> Refus RH <span class="tab-badge">{{ count_refusees_rh }}</span>
            </button>
        </div>

        <!-- ONGLET 1 : À valider RH -->
        <div class="tab-content {% if onglet_actif == 'a_valider_rh' %}active{% endif %}" id="tab-a_valider_rh">
            {% if demandes_a_valider_rh %}
                {% for item in demandes_a_valider_rh %}
                {% with demande=item.demande solde=item.solde %}
                <div class="demande-card">
                    <div class="demande-header">
                        <div class="demande-employe">
                            <div class="avatar-medium">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                            <div class="employe-details">
                                <h3>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h3>
                                <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                            </div>
                        </div>
                        <span class="type-badge">{{ demande.type_absence.LIBELLE }}</span>
                    </div>
                    <div class="demande-info-grid">
                        <div class="info-item">
                            <span class="info-label">Date début</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_debut|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date fin</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_fin|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Durée demandée</span>
                            <span class="info-value"><i class="far fa-clock"></i> <strong>{{ demande.nombre_jours|floatformat:1 }}</strong> jour{{ demande.nombre_jours|floatformat:1|pluralize }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Solde disponible</span>
                            <span class="info-value">
                                {% if demande.type_absence.CODE == 'CPN' %}
                                    <span class="solde-badge {% if solde.jours_disponibles >= demande.nombre_jours %}positif{% elif solde.jours_disponibles > 0 %}neutre{% else %}negatif{% endif %}">
                                        {{ solde.jours_disponibles|floatformat:1 }} jours
                                    </span>
                                {% elif demande.type_absence.CODE == 'RTT' %}
                                    <span class="solde-badge {% if solde.rtt_disponibles >= demande.nombre_jours %}positif{% elif solde.rtt_disponibles > 0 %}neutre{% else %}negatif{% endif %}">
                                        {{ solde.rtt_disponibles|floatformat:1 }} RTT
                                    </span>
                                {% else %}
                                    <span style="color: #9ca3af;">N/A</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% if demande.motif %}
                    <div class="demande-motif">
                        <strong><i class="fas fa-comment"></i> Motif :</strong> {{ demande.motif }}
                    </div>
                    {% endif %}
                    <div class="demande-actions">
                        <button class="btn btn-success" onclick="ouvrirModalValidation('{{ demande.id }}', '{{ demande.numero_demande }}')">
                            <i class="fas fa-check"></i> Valider
                        </button>
                        <button class="btn btn-danger" onclick="ouvrirModalRefus('{{ demande.id }}', '{{ demande.numero_demande }}')">
                            <i class="fas fa-times"></i> Refuser
                        </button>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>Aucune demande à valider</h3>
                </div>
            {% endif %}
        </div>

        <!-- ONGLET 2 : En Attente -->
        <div class="tab-content {% if onglet_actif == 'en_attente' %}active{% endif %}" id="tab-en_attente">
            {% if demandes_en_attente %}
                {% for item in demandes_en_attente %}
                {% with demande=item.demande solde=item.solde %}
                <div class="demande-card">
                    <div style="position: absolute; top: 15px; right: 15px;">
                        <span style="background: #fbbf24; color: white; padding: 5px 12px; border-radius: 20px;">
                            <i class="fas fa-clock"></i> EN ATTENTE MANAGER
                        </span>
                    </div>
                    <div class="demande-header">
                        <div class="demande-employe">
                            <div class="avatar-medium">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                            <div class="employe-details">
                                <h3>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h3>
                                <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                            </div>
                        </div>
                        <span class="type-badge">{{ demande.type_absence.LIBELLE }}</span>
                    </div>
                    <div class="demande-info-grid">
                        <div class="info-item">
                            <span class="info-label">Date début</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_debut|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date fin</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_fin|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Durée demandée</span>
                            <span class="info-value"><i class="far fa-clock"></i> <strong>{{ demande.nombre_jours|floatformat:1 }}</strong> jour{{ demande.nombre_jours|floatformat:1|pluralize }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Solde disponible</span>
                            <span class="info-value">
                                {% if demande.type_absence.CODE == 'CPN' %}
                                    <span class="solde-badge {% if solde.jours_disponibles >= demande.nombre_jours %}positif{% elif solde.jours_disponibles > 0 %}neutre{% else %}negatif{% endif %}">
                                        {{ solde.jours_disponibles|floatformat:1 }} jours
                                    </span>
                                {% elif demande.type_absence.CODE == 'RTT' %}
                                    <span class="solde-badge {% if solde.rtt_disponibles >= demande.nombre_jours %}positif{% elif solde.rtt_disponibles > 0 %}neutre{% else %}negatif{% endif %}">
                                        {{ solde.rtt_disponibles|floatformat:1 }} RTT
                                    </span>
                                {% else %}
                                    <span style="color: #9ca3af;">N/A</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% if demande.motif %}
                    <div class="demande-motif">
                        <strong><i class="fas fa-comment"></i> Motif :</strong> {{ demande.motif }}
                    </div>
                    {% endif %}
                </div>
                {% endwith %}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>Aucune demande en attente</h3>
                </div>
            {% endif %}
        </div>

        <!-- ONGLET 3 : Validées RH -->
        <div class="tab-content {% if onglet_actif == 'validees_rh' %}active{% endif %}" id="tab-validees_rh">
            {% if demandes_validees_rh %}
                {% for demande in demandes_validees_rh %}
                <div class="demande-card">
                    <div class="demande-header">
                        <div class="demande-employe">
                            <div class="avatar-medium">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                            <div class="employe-details">
                                <h3>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h3>
                                <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                            </div>
                        </div>
                        <span class="type-badge">{{ demande.type_absence.LIBELLE }}</span>
                    </div>
                    <div class="demande-info-grid">
                        <div class="info-item">
                            <span class="info-label">Date début</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_debut|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date fin</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_fin|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Durée</span>
                            <span class="info-value"><i class="far fa-clock"></i> <strong>{{ demande.nombre_jours|floatformat:1 }}</strong> jour{{ demande.nombre_jours|floatformat:1|pluralize }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Validé le</span>
                            <span class="info-value" style="color: #10b981;"><i class="fas fa-check-circle"></i> {{ demande.date_validation_rh|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    {% if demande.motif %}
                    <div class="demande-motif">
                        <strong><i class="fas fa-comment"></i> Motif employé :</strong> {{ demande.motif }}
                    </div>
                    {% endif %}
                    {% if demande.commentaire_rh %}
                    <div style="background: #d1fae5; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <strong style="color: #065f46;"><i class="fas fa-user-shield"></i> Commentaire RH :</strong> {{ demande.commentaire_rh }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3>Aucune demande validée</h3>
                </div>
            {% endif %}
        </div>

        <!-- ONGLET 4 : Refusées Manager -->
        <div class="tab-content {% if onglet_actif == 'refusees_manager' %}active{% endif %}" id="tab-refusees_manager">
            {% if demandes_refusees_manager %}
                {% for demande in demandes_refusees_manager %}
                <div class="demande-card">
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 15px;">
                        <strong style="color: #991b1b;">
                            <i class="fas fa-times-circle"></i> Refusé par {{ demande.validateur_manager.nom }} le {{ demande.date_validation_manager|date:"d/m/Y" }}
                        </strong>
                        <p style="margin-top: 8px; color: #991b1b;">{{ demande.motif_refus_manager }}</p>
                    </div>
                    <div class="demande-header">
                        <div class="demande-employe">
                            <div class="avatar-medium">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                            <div class="employe-details">
                                <h3>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h3>
                                <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                            </div>
                        </div>
                        <span class="type-badge">{{ demande.type_absence.LIBELLE }}</span>
                    </div>
                    <div class="demande-info-grid">
                        <div class="info-item">
                            <span class="info-label">Date début</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_debut|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date fin</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_fin|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Durée</span>
                            <span class="info-value"><i class="far fa-clock"></i> <strong>{{ demande.nombre_jours|floatformat:1 }}</strong> jour{{ demande.nombre_jours|floatformat:1|pluralize }}</span>
                        </div>
                    </div>
                    {% if demande.motif %}
                    <div class="demande-motif">
                        <strong><i class="fas fa-comment"></i> Motif employé :</strong> {{ demande.motif }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-user-times"></i>
                    <h3>Aucun refus manager</h3>
                </div>
            {% endif %}
        </div>

        <!-- ONGLET 5 : Refusées RH -->
        <div class="tab-content {% if onglet_actif == 'refusees_rh' %}active{% endif %}" id="tab-refusees_rh">
            {% if demandes_refusees_rh %}
                {% for demande in demandes_refusees_rh %}
                <div class="demande-card">
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 15px;">
                        <strong style="color: #991b1b;">
                            <i class="fas fa-ban"></i> Refusé par {{ demande.validateur_rh.nom }} le {{ demande.date_validation_rh|date:"d/m/Y" }}
                        </strong>
                        <p style="margin-top: 8px; color: #991b1b;">{{ demande.motif_refus_rh }}</p>
                    </div>
                    <div class="demande-header">
                        <div class="demande-employe">
                            <div class="avatar-medium">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                            <div class="employe-details">
                                <h3>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h3>
                                <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                            </div>
                        </div>
                        <span class="type-badge">{{ demande.type_absence.LIBELLE }}</span>
                    </div>
                    <div class="demande-info-grid">
                        <div class="info-item">
                            <span class="info-label">Date début</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_debut|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date fin</span>
                            <span class="info-value"><i class="far fa-calendar"></i> {{ demande.date_fin|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Durée</span>
                            <span class="info-value"><i class="far fa-clock"></i> <strong>{{ demande.nombre_jours|floatformat:1 }}</strong> jour{{ demande.nombre_jours|floatformat:1|pluralize }}</span>
                        </div>
                    </div>
                    {% if demande.motif %}
                    <div class="demande-motif">
                        <strong><i class="fas fa-comment"></i> Motif employé :</strong> {{ demande.motif }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-ban"></i>
                    <h3>Aucun refus RH</h3>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modaux -->
<div id="modalValidation" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-check-circle" style="color: #10b981;"></i> Valider la demande</h2>
            <span class="close" onclick="fermerModalValidation()">&times;</span>
        </div>
        <div class="form-group">
            <label>Commentaire RH (optionnel)</label>
            <textarea id="commentaireValidation" placeholder="Ajouter un commentaire..."></textarea>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="fermerModalValidation()">Annuler</button>
            <button class="btn btn-success" onclick="confirmerValidationRH()"><i class="fas fa-check"></i> Valider</button>
        </div>
    </div>
</div>

<div id="modalRefus" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-times-circle" style="color: #ef4444;"></i> Refuser la demande</h2>
            <span class="close" onclick="fermerModalRefus()">&times;</span>
        </div>
        <div class="form-group">
            <label>Motif du refus *</label>
            <textarea id="motifRefusRH" placeholder="Veuillez expliquer..."></textarea>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="fermerModalRefus()">Annuler</button>
            <button class="btn btn-danger" onclick="confirmerRefusRH()"><i class="fas fa-times"></i> Refuser</button>
        </div>
    </div>
</div>
<script src="{% static 'assets/js/main.js' %}"></script>
<script>
    let demandeEnCours = null;
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function changeTab(tabName) {
        document.querySelector('input[name="onglet"]').value = tabName;
        document.getElementById('filterForm').submit();
    }

    function resetFilters() {
        window.location.href = '?onglet={{ onglet_actif }}';
    }

    function ouvrirModalValidation(demandeId, numeroDemande) {
        demandeEnCours = demandeId;
        document.getElementById('commentaireValidation').value = '';
        document.getElementById('modalValidation').style.display = 'block';
    }

    function fermerModalValidation() {
        document.getElementById('modalValidation').style.display = 'none';
        demandeEnCours = null;
    }

    function confirmerValidationRH() {
        const commentaire = document.getElementById('commentaireValidation').value.trim();
        const csrftoken = getCookie('csrftoken');
        fetch(`{% url 'absence:rh_valider_demande' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', demandeEnCours), {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `commentaire_rh=${encodeURIComponent(commentaire)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) { alert(data.message); fermerModalValidation(); location.reload(); }
            else { alert('Erreur: ' + data.error); }
        })
        .catch(error => { console.error('Erreur:', error); alert('Erreur lors de la validation'); });
    }

    function ouvrirModalRefus(demandeId, numeroDemande) {
        demandeEnCours = demandeId;
        document.getElementById('motifRefusRH').value = '';
        document.getElementById('modalRefus').style.display = 'block';
    }

    function fermerModalRefus() {
        document.getElementById('modalRefus').style.display = 'none';
        demandeEnCours = null;
    }

    function confirmerRefusRH() {
        const motif = document.getElementById('motifRefusRH').value.trim();
        if (!motif) { alert('Veuillez saisir un motif de refus'); return; }
        const csrftoken = getCookie('csrftoken');
        fetch(`{% url 'absence:rh_refuser_demande' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', demandeEnCours), {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `motif_refus_rh=${encodeURIComponent(motif)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) { alert(data.message); fermerModalRefus(); location.reload(); }
            else { alert('Erreur: ' + data.error); }
        })
        .catch(error => { console.error('Erreur:', error); alert('Erreur lors du refus'); });
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            demandeEnCours = null;
        }
    }
</script>
</body>
</html>