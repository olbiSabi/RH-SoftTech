{% extends 'base/baseSansMatricule.html' %}
{% load static %}

{% block extrastylet %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="{% static 'assets/css/absence/acquisitions.css' %}">
<style>
#detail_mois_container .badge {
    transition: all 0.3s ease;
    cursor: default;
}

#detail_mois_container .badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

#detail_mois_container .badge-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

#detail_mois_container .badge-secondary {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
}
</style>
{% endblock %}

{% block pageContent %}

<section class="content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Acquisitions de Cong√©s</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">

        <!-- Calcul en masse -->
        <div class="card mb-4">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calculator"></i> Calcul Automatique des Acquisitions
                </h5>
            </div>
            <div class="card-body">
                <form id="calculForm" method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="id_annee_reference">Ann√©e de r√©f√©rence</label>
                                {{ calcul_form.annee_reference }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label> <!-- Espacement pour aligner avec les autres champs -->
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox"
                                           class="custom-control-input"
                                           id="id_recalculer_existantes"
                                           name="recalculer_existantes"
                                           {% if request.GET.recalculer_existantes or request.POST.recalculer_existantes %}checked{% endif %}>
                                    <label class="custom-control-label" for="id_recalculer_existantes">
                                        Recalculer les existantes
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Employ√©s (optionnel)</label>
                                <small class="form-text text-muted mb-2">
                                    Laissez vide pour tous les employ√©s actifs
                                </small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label> <!-- Espacement -->

                                {% if annee_verrouille %}
                                <!-- Ann√©e verrouill√©e : bouton d√©sactiv√© -->
                                <button type="button"
                                        class="btn btn-secondary btn-block"
                                        disabled
                                        title="Impossible de calculer l'ann√©e {{ annee_filter }}. {{ message_verrouillage }}">
                                    <i class="fas fa-lock"></i> Verrouill√©e
                                </button>
                                <small class="text-danger mt-2 d-block">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ message_verrouillage }}
                                </small>
                                {% else %}
                                <!-- Ann√©e modifiable : bouton actif -->
                                <button type="submit" class="btn btn-success btn-block">
                                    <i class="fas fa-calculator"></i> Calculer
                                </button>

                                {% if date_limite_recalcul %}
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle"></i>
                                    Recalcul possible jusqu'au {{ date_limite_recalcul|date:"d/m/Y" }}
                                </small>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% comment %}
        <div class="card mb-4">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day"></i> Simulation : Calculer √† une date pr√©cise
                </h5>
            </div>
            <div class="card-body">
                <form id="simulationForm" class="form-inline">
                    <div class="form-group mr-3">
                        <label for="sim_employe" class="mr-2">Employ√©</label>
                        <select id="sim_employe" class="form-control" required>
                            <option value="">-- S√©lectionner --</option>
                            {% for emp in employes %}
                            <option value="{{ emp.uuid }}">{{ emp.matricule }} - {{ emp.nom }} {{ emp.prenoms }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group mr-3">
                        <label for="sim_annee" class="mr-2">Ann√©e</label>
                        <select id="sim_annee" class="form-control" required>
                            {% for annee in annees %}
                            <option value="{{ annee }}">{{ annee }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group mr-3">
                        <label for="sim_date" class="mr-2">Date de r√©f√©rence</label>
                        <input type="date"
                               id="sim_date"
                               class="form-control"
                               value="{{ today|date:'Y-m-d' }}"
                               required>
                    </div>

                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-calculator"></i> Simuler
                    </button>
                </form>

                <!-- R√©sultat de la simulation -->
                <div id="simulationResult" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> R√©sultat de la simulation</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <th>Employ√©:</th>
                                <td id="result_employe"></td>
                            </tr>
                            <tr>
                                <th>Date de r√©f√©rence:</th>
                                <td id="result_date"></td>
                            </tr>
                            <tr>
                                <th>Mois travaill√©s:</th>
                                <td id="result_mois"></td>
                            </tr>
                            <tr>
                                <th class="text-success">Jours acquis:</th>
                                <td class="text-success font-weight-bold" id="result_jours"></td>
                            </tr>
                        </table>

                        <!-- ‚úÖ NOUVEAU : Conteneur pour le d√©tail des mois -->
                        <div id="detail_mois_container"></div>
                    </div>
                </div>

            </div>
        </div>
        {% endcomment %}

        <!-- Filtres et Liste -->
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-8">
                        <form method="GET" id="filterForm" class="form-inline">
                            <!-- Recherche -->
                            <div class="input-group input-group-sm mr-2 group-spaced mb-2">
                                <input type="text"
                                       name="search"
                                       class="form-control"
                                       placeholder="Rechercher..."
                                       value="{{ search }}">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Filtre Ann√©e -->
                            <select name="annee" class="form-control form-control-sm mr-2 group-spaced mb-2" onchange="this.form.submit()">
                                {% for annee in annees %}
                                <option value="{{ annee }}" {% if annee_filter|stringformat:"s" == annee|stringformat:"s" %}selected{% endif %}>
                                    {{ annee }}
                                </option>
                                {% empty %}
                                <option value="{{ annee_filter }}">{{ annee_filter }}</option>
                                {% endfor %}
                            </select>

                            <!-- Filtre Employ√© -->
                            <select name="employe" class="form-control form-control-sm mr-2 group-spaced mb-2" onchange="this.form.submit()">
                                <option value="">Tous les employ√©s</option>
                                {% for emp in employes %}
                                <option value="{{ emp.matricule }}" {% if employe_filter == emp.matricule %}selected{% endif %}>
                                    {{ emp.nom }} {{ emp.prenoms }}
                                </option>
                                {% endfor %}
                            </select>

                            <!-- Bouton Reset -->
                            {% if search or employe_filter %}
                            <a href="{% url 'absence:liste_acquisitions' %}?annee={{ annee_filter }}"
                               class="btn btn-secondary btn-sm mb-2">
                                <i class="fas fa-redo"></i> R√©initialiser
                            </a>
                            {% endif %}
                        </form>
                    </div>
                    <div class="col-md-4 text-right">
                        <button type="button"
                                class="btn btn-info btn-sm"
                                onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Exporter
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="acquisitionsTable">
                        <thead class="bg-light">
                        <tr>
                            <th>#</th>
                            <th>Matricule</th>
                            <th>Employ√©</th>
                            <th>Ann√©e</th>
                            <th>Convention</th>
                            <th class="text-center">Acquis</th>
                            <th class="text-center">Pris</th>
                            <th class="text-center">Restants</th>
                            <th class="text-center">Report Ant.</th>
                            <th class="text-center">Nouveau Report</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for acq in acquisitions %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <span class="badge badge-secondary">{{ acq.employe.matricule }}</span>
                            </td>
                            <td>
                                <strong>{{ acq.employe.nom }} {{ acq.employe.prenoms }}</strong>
                                {% if acq.employe.coefficient_temps_travail != 1.00 %}
                                <br>
                                <small class="text-info">
                                    <i class="fas fa-clock"></i> {{ acq.employe.coefficient_temps_travail|floatformat:2 }}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-dark">{{ acq.annee_reference }}</span>
                            </td>
                            <td>
                                {% if acq.employe.convention_personnalisee %}
                                <span class="badge badge-info" title="Convention personnalis√©e">
                                    <i class="fas fa-user-tie"></i> {{ acq.employe.convention_personnalisee.code }}
                                </span>
                                {% elif acq.employe.entreprise.configuration_conventionnelle %}
                                <span class="badge badge-success" title="Convention entreprise">
                                    <i class="fas fa-building"></i> {{ acq.employe.entreprise.configuration_conventionnelle.code }}
                                </span>
                                {% else %}
                                <span class="badge badge-danger">Aucune</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="badge badge-lg badge-success">
                                    {{ acq.jours_acquis|floatformat:2 }}j
                                </span>
                                <br>
                                <small class="text-muted" title="Derni√®re mise √† jour">
                                    <i class="fas fa-clock"></i> {{ acq.date_maj|date:"d/m/Y H:i" }}
                                </small>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-lg badge-warning">
                                    {{ acq.jours_pris|floatformat:2 }}j
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-lg badge-primary">
                                    {{ acq.jours_restants|floatformat:2 }}j
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-lg badge-info">
                                    {{ acq.jours_report_anterieur|floatformat:2 }}j
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-lg badge-secondary">
                                    {{ acq.jours_report_nouveau|floatformat:2 }}j
                                </span>
                            </td>
                            <td class="text-center action-buttons">
                                {% if acq.est_verrouille_cache %}
                                <!-- Ann√©e verrouill√©e : D√©tails uniquement -->
                                <button type="button"
                                        class="btn btn-sm btn-info"
                                        onclick="openDetailModal({{ acq.id }})"
                                        title="D√©tails">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <span class="badge badge-secondary"
                                      title="Ann√©e {{ acq.annee_reference }} verrouill√©e. D√©lai expir√© le {{ acq.date_limite_modification_cache|date:'d/m/Y' }}">
                                    <i class="fas fa-lock"></i> Verrouill√©e
                                </span>

                                {% elif acq.est_dans_delai_grace_cache %}
                                <!-- Dans les 2 derniers jours : boutons avec avertissement -->
                                <button type="button"
                                        class="btn btn-sm btn-info"
                                        onclick="openDetailModal({{ acq.id }})"
                                        title="D√©tails">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-warning btn-sm"
                                        onclick="openEditModal({{ acq.id }})"
                                        title="Modifier le report - ATTENTION : Dernier d√©lai le {{ acq.date_limite_modification_cache|date:'d/m/Y' }}">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-warning btn-sm"
                                        onclick="recalculerAcquisition({{ acq.id }})"
                                        title="Recalculer - ATTENTION : Dernier d√©lai le {{ acq.date_limite_modification_cache|date:'d/m/Y' }}">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        onclick="deleteAcquisition({{ acq.id }}, '{{ acq.employe|escapejs }}', {{ acq.annee_reference }})"
                                        title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>

                                {% else %}
                                <!-- Ann√©e modifiable : tous les boutons normaux -->
                                <button type="button"
                                        class="btn btn-sm btn-info"
                                        onclick="openDetailModal({{ acq.id }})"
                                        title="D√©tails">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-primary"
                                        onclick="openEditModal({{ acq.id }})"
                                        title="Modifier le report">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-success"
                                        onclick="recalculerAcquisition({{ acq.id }})"
                                        title="Recalculer">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        onclick="deleteAcquisition({{ acq.id }}, '{{ acq.employe|escapejs }}', {{ acq.annee_reference }})"
                                        title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Aucune acquisition trouv√©e
                                <br>
                                <button class="btn btn-primary mt-3" onclick="$('#calculForm').submit()">
                                    <i class="fas fa-calculator"></i> Calculer les acquisitions
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal Confirmation Calcul Acquisitions -->
<div id="modalCalculAcquisitions" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #fff; margin: 10% auto; padding: 0; border-radius: 8px; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div class="modal-header" style="background: #28a745; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0; font-size: 20px;">
                <i class="fas fa-calculator"></i> Confirmer le calcul
            </h2>
            <span class="close" onclick="fermerModalCalcul()" style="float: right; cursor: pointer; font-size: 28px; font-weight: bold; color: white; margin-top: -30px;">&times;</span>
        </div>

        <div style="padding: 20px;">
            <p style="margin-bottom: 15px; font-size: 16px;">
                <strong>Calculer les acquisitions pour l'ann√©e <span id="calcul_annee"></span> ?</strong>
            </p>

            <div id="calcul_warning" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <p style="margin: 0; color: #856404;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Les acquisitions existantes seront recalcul√©es.</strong>
                </p>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="fermerModalCalcul()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-success" onclick="confirmerCalcul()">
                    <i class="fas fa-calculator"></i> Calculer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Recalcul Acquisition -->
<div id="modalRecalculAcquisition" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #fff; margin: 10% auto; padding: 0; border-radius: 8px; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div class="modal-header" style="background: #17a2b8; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0; font-size: 20px;">
                <i class="fas fa-sync-alt"></i> Confirmer le recalcul
            </h2>
            <span class="close" onclick="fermerModalRecalcul()" style="float: right; cursor: pointer; font-size: 28px; font-weight: bold; color: white; margin-top: -30px;">&times;</span>
        </div>

        <div style="padding: 20px;">
            <p style="margin-bottom: 15px; font-size: 16px;">
                <strong>Recalculer cette acquisition ?</strong>
            </p>

            <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <p style="margin: 0; color: #0c5460;">
                    <i class="fas fa-info-circle"></i> Les jours acquis seront recalcul√©s selon la convention applicable.
                </p>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="fermerModalRecalcul()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-info" onclick="confirmerRecalcul(event); return false;">
                    <i class="fas fa-sync-alt"></i> Recalculer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Suppression Acquisition -->
<div id="modalSuppressionAcquisition" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #fff; margin: 10% auto; padding: 0; border-radius: 8px; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div class="modal-header" style="background: #dc2626; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0; font-size: 20px;">
                <i class="fas fa-exclamation-triangle"></i> Confirmer la suppression
            </h2>
            <span class="close" onclick="fermerModalSuppressionAcquisition()" style="float: right; cursor: pointer; font-size: 28px; font-weight: bold; color: white; margin-top: -30px;">&times;</span>
        </div>

        <div style="padding: 20px;">
            <p style="margin-bottom: 15px; font-size: 16px;">
                <strong>ATTENTION :</strong> Vous √™tes sur le point de supprimer d√©finitivement cette acquisition.
            </p>

            <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <p style="margin: 0; color: #991b1b;">
                    <i class="fas fa-user"></i> <strong>Employ√© : <span id="suppression_acquisition_employe"></span></strong><br>
                    <i class="fas fa-calendar"></i> <strong>Ann√©e : <span id="suppression_acquisition_annee"></span></strong>
                </p>
            </div>

            <p style="color: #dc2626; font-weight: 500; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> Cette action est irr√©versible !
            </p>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="fermerModalSuppressionAcquisition()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" style="background: #dc2626; border-color: #dc2626;" onclick="confirmerSuppressionAcquisition()">
                    <i class="fas fa-trash"></i> Supprimer d√©finitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal D√©tails -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> D√©tails de l'Acquisition
                </h5>
                <button type="button"
                        class="close text-white"
                        data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="detailContent">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal √âdition Report -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Modifier le Report Ant√©rieur
                </h5>
                <button type="button"
                        class="close text-white"
                        data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editForm">
                {% csrf_token %}
                <input type="hidden" id="edit_acquisition_id">

                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Seul le <strong>report de l'ann√©e pr√©c√©dente</strong> peut √™tre modifi√© manuellement.
                        Les autres valeurs sont calcul√©es automatiquement.
                    </div>

                    <div class="form-group">
                        <label>Employ√©</label>
                        <input type="text" class="form-control" id="edit_employe_nom" readonly>
                    </div>

                    <div class="form-group">
                        <label>Ann√©e</label>
                        <input type="text" class="form-control" id="edit_annee" readonly>
                    </div>

                    <div class="form-group">
                        <label for="edit_jours_report_anterieur">
                            Report de l'ann√©e pr√©c√©dente (jours) <span class="text-danger">*</span>
                        </label>
                        <input type="number"
                               class="form-control"
                               id="edit_jours_report_anterieur"
                               name="jours_report_anterieur"
                               step="0.01"
                               min="0"
                               max="30"
                               required>
                        <small class="form-text text-muted">
                            Jours de cong√© report√©s de l'ann√©e pr√©c√©dente
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Jours Restants (apr√®s modification)</label>
                        <input type="text" class="form-control" id="edit_jours_restants_preview" readonly>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitEditBtn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extrascript %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="{% static 'assets/js/absence/acquisitions.js' %}"></script>

<script>
// ========================================
// GESTION DES MODALS DE CONFIRMATION
// ========================================

// Variables globales
let modalCalculData = null;
let modalRecalculAcquisitionId = null;
let modalSuppressionData = null;

// Modal Calcul
function ouvrirModalCalcul(annee, recalculer) {
    modalCalculData = { annee, recalculer };
    document.getElementById('calcul_annee').textContent = annee;

    if (recalculer) {
        document.getElementById('calcul_warning').style.display = 'block';
    } else {
        document.getElementById('calcul_warning').style.display = 'none';
    }

    document.getElementById('modalCalculAcquisitions').style.display = 'block';
}

function fermerModalCalcul() {
    document.getElementById('modalCalculAcquisitions').style.display = 'none';
    modalCalculData = null;
}

function confirmerCalcul() {
    if (modalCalculData) {
        calculerAcquisitionsConfirmed();
        fermerModalCalcul();
    }
}

// Modal Recalcul
function ouvrirModalRecalcul(acquisitionId) {
    console.log('üìã ouvrirModalRecalcul appel√© avec ID:', acquisitionId);
    modalRecalculAcquisitionId = acquisitionId;
    console.log('üìã modalRecalculAcquisitionId d√©fini √†:', modalRecalculAcquisitionId);
    document.getElementById('modalRecalculAcquisition').style.display = 'block';
    console.log('‚úÖ Modal affich√©');
}

function fermerModalRecalcul() {
    document.getElementById('modalRecalculAcquisition').style.display = 'none';
    modalRecalculAcquisitionId = null;
}

function confirmerRecalcul(event) {
    // Emp√™cher la soumission du formulaire
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('üîò confirmerRecalcul appel√©, modalRecalculAcquisitionId:', modalRecalculAcquisitionId);
    
    if (modalRecalculAcquisitionId) {
        console.log('‚úÖ ID trouv√©, appel de executeRecalcul');
        
        // V√©rifier si executeRecalcul existe
        if (typeof executeRecalcul === 'function') {
            executeRecalcul(modalRecalculAcquisitionId);
        } else {
            console.log('‚ùå executeRecalcul NON TROUV√â, utilisation de la version locale');
            executeRecalculLocal(modalRecalculAcquisitionId);
        }
        
        fermerModalRecalcul();
    } else {
        console.log('‚ùå ERREUR: modalRecalculAcquisitionId est NULL ou undefined');
    }
    
    return false; // Emp√™cher la navigation
}

// Version locale de executeRecalcul si celle du JS n'est pas trouv√©e
function executeRecalculLocal(acquisitionId) {
    console.log('üöÄ executeRecalculLocal appel√© avec ID:', acquisitionId);
    
    // Afficher un loader simple
    const loaderHtml = '<div id="loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;"><div style="background: white; padding: 20px; border-radius: 8px; text-align: center;"><i class="fas fa-sync-alt fa-spin"></i><br>Recalcul en cours...</div></div>';
    document.body.insertAdjacentHTML('beforeend', loaderHtml);

    console.log('üì° Envoi requ√™te AJAX vers:', `/absence/api/acquisition/${acquisitionId}/recalculer/`);
    console.log('üç™ CSRF Token:', getCookie('csrftoken'));

    $.ajax({
        url: `/absence/api/acquisition/${acquisitionId}/recalculer/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: {
            csrfmiddlewaretoken: getCookie('csrftoken')
        },
        beforeSend: function(xhr) {
            console.log('üì§ beforeSend appel√©');
        },
        success: function(response) {
            console.log('‚úÖ Succ√®s AJAX:', response);
            
            // Retirer le loader
            const loader = document.getElementById('loader');
            if (loader) loader.remove();

            if (response.success) {
                alert('‚úÖ Acquisition recalcul√©e avec succ√®s!\\nJours acquis: ' + response.jours_acquis + '\\nJours restants: ' + response.jours_restants);
                window.location.reload();
            } else {
                alert('‚ùå Erreur: ' + (response.error || 'Erreur lors du recalcul'));
            }
        },
        error: function(xhr) {
            console.error('‚ùå ERREUR AJAX - D√©tails complets:');
            console.error('Status:', xhr.status);
            console.error('Status Text:', xhr.statusText);
            console.error('Response Text:', xhr.responseText);
            
            // Retirer le loader
            const loader = document.getElementById('loader');
            if (loader) loader.remove();
            
            alert('‚ùå Erreur technique: ' + xhr.status + ' ' + xhr.statusText);
        }
    });
}

// Modal Suppression
function ouvrirModalSuppressionAcquisition(acquisitionId, employeNom, annee) {
    modalSuppressionData = { acquisitionId, employeNom, annee };
    document.getElementById('suppression_acquisition_employe').textContent = employeNom;
    document.getElementById('suppression_acquisition_annee').textContent = annee;
    document.getElementById('modalSuppressionAcquisition').style.display = 'block';
}

function fermerModalSuppressionAcquisition() {
    document.getElementById('modalSuppressionAcquisition').style.display = 'none';
    modalSuppressionData = null;
}

function confirmerSuppressionAcquisition() {
    if (modalSuppressionData) {
        deleteAcquisitionConfirmed(modalSuppressionData.acquisitionId);
        fermerModalSuppressionAcquisition();
    }
}

// Fermer les modals en cliquant en dehors
window.onclick = function(event) {
    const modalCalcul = document.getElementById('modalCalculAcquisitions');
    const modalRecalcul = document.getElementById('modalRecalculAcquisition');
    const modalSuppression = document.getElementById('modalSuppressionAcquisition');

    if (event.target === modalCalcul) {
        fermerModalCalcul();
    }
    if (event.target === modalRecalcul) {
        fermerModalRecalcul();
    }
    if (event.target === modalSuppression) {
        fermerModalSuppressionAcquisition();
    }
};
</script>
{% endblock %}