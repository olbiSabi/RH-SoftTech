{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EasyM{% endblock %}</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/logo/Onian-EasyM.png' %}">
    <!-- Chargez les CSS un par un pour debug -->
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/dossier_individuel.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/dossier_individuel_base.css' %}">
</head>
<body data-employe-uuid="{% if employe %}{{ employe.uuid }}{% endif %}">
<!-- Header -->
{% include 'base/header.html' %}

<!-- Container principal -->
<div class="container-fluid">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Liste des Employ√©s ({{ employes_actifs.count }})</h2>
            <input type="text" class="search-box" placeholder="Rechercher un employ√©..." id="searchBox">
        </div>
        <ul class="employee-list" id="employeeList">
            {% for emp in employes_actifs %}
            <li class="employee-item {% if employe and emp.uuid == employe.uuid %}active{% endif %}"
                data-uuid="{{ emp.uuid }}">
                <div class="employee-matricule">{{ emp.matricule }}</div>
                <div class="employee-name">{{ emp.username }} {{ emp.prenomuser }}</div>
            </li>
            {% empty %}
            <li style="padding: 20px; text-align: center; color: #999;">
                Aucun employ√© trouv√©
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Content principal -->
    <div class="content">
        {% if not employe %}
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3>S√©lectionnez un employ√©</h3>
            <p>Cliquez sur un employ√© dans la liste pour afficher ses informations</p>
        </div>
        {% else %}
        <div class="content-header">
            <!-- Photo cliquable -->
            <div class="photo-container">
                <img src="{{ employe.get_photo_url }}"
                     alt="{{ employe.nom }}"
                     class="employee-photo photo-clickable"
                     id="employeePhoto"
                     data-employe-uuid="{{ employe.uuid }}">
                <input type="file"
                       id="photoInput"
                       accept=".jpg,.jpeg,.png,.gif"
                       style="display: none;">
            </div>
            <div class="employee-info">
                <h1 class="employee-title">{{ employe.username }} {{ employe.prenomuser }}</h1>
                <p class="employee-subtitle">
                    Matricule: {{ employe.matricule }} |
                    {% if employe.etat == 'actif' %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </p>
            </div>
        </div>
        <!-- Onglets -->
        <div class="tabs-wrapper">
            <div class="tabs">
                <a href="{% url 'absence_individuel_detail' employe.uuid %}?tab=donnees"
                   class="tab {% if request.GET.tab == 'donnees' or not request.GET.tab %}active{% endif %}">
                    <i class="fas fa-user"></i>
                    <span class="tab-text">Donn√©es Agent</span>
                </a>
                <a href="{% url 'absence_individuel_detail' employe.uuid %}?tab=coordonnees"
                   class="tab {% if request.GET.tab == 'coordonnees' %}active{% endif %}">
                    <i class="fas fa-address-book"></i>
                    <span class="tab-text">Coordonn√©es</span>
                </a>
            </div>
        </div>

        {% include 'employee/onglets/onglet_dossier_individuel.html' %}

        {% endif %}
    </div>
</div>

<!-- MODALES -->
{% if employe %}

<!--{% include 'employee/modal/modal_dossier_individuel.html' %}-->

{% endif %}

<script src="{% static 'assets/js/absence_individuel.js' %}"></script>
<script>

    document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Fonction pour ouvrir le sidebar
        function openSidebar() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Emp√™che le scroll du body
        }

        // Fonction pour fermer le sidebar
        function closeSidebar() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restaure le scroll
        }

        // Toggle au clic sur le bouton hamburger
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                if (sidebar.classList.contains('active')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
        }

        // Fermer en cliquant sur l'overlay
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebar);
        }

        // Fermer le sidebar apr√®s avoir s√©lectionn√© un employ√© (optionnel)
        const employeeItems = document.querySelectorAll('.employee-item');
        employeeItems.forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            });
        });
    });


        // Gestion du changement de photo
        document.addEventListener('DOMContentLoaded', function() {
            const photoElement = document.getElementById('employeePhoto');
            const photoInput = document.getElementById('photoInput');
            const photoOverlay = document.querySelector('.photo-overlay');

            if (photoElement && photoInput) {
                // Rendre la photo et l'overlay cliquables
                photoElement.addEventListener('click', () => photoInput.click());
                if (photoOverlay) {
                    photoOverlay.addEventListener('click', () => photoInput.click());
                }

                // G√©rer le changement de fichier
                photoInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Validation
                    const ext = '.' + file.name.split('.').pop().toLowerCase();
                    if (!['.jpg', '.jpeg', '.png', '.gif'].includes(ext)) {
                        showAlert('Format non autoris√©. Formats accept√©s: JPG, JPEG, PNG, GIF', 'danger');
                        return;
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        showAlert('La taille de la photo ne doit pas d√©passer 5 MB', 'danger');
                        return;
                    }

                    // Aper√ßu imm√©diat
                    const reader = new FileReader();
                    reader.onload = (e) => photoElement.src = e.target.result;
                    reader.readAsDataURL(file);

                    // Envoyer au serveur
                    await uploadPhoto(file, photoElement);
                });
            }
        });

        async function uploadPhoto(file, photoElement) {
            const formData = new FormData();
            formData.append('employe_uuid', photoElement.dataset.employeUuid);
            formData.append('photo', file);

            showLoading();
            try {
                const response = await fetch('/employe/ajax/photo/modifier/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken},
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('‚úÖ Photo mise √† jour avec succ√®s', 'success');
                    if (data.photo_url) {
                        photoElement.src = data.photo_url + '?t=' + new Date().getTime();
                    }
                } else {
                    showAlert('‚ùå ' + (data.error || 'Erreur inconnue'), 'danger');
                }
            } catch (error) {
                showAlert('‚ùå Erreur lors du t√©l√©chargement', 'danger');
            } finally {
                hideLoading();
                document.getElementById('photoInput').value = '';
            }
        }
</script>
</body>
</html>