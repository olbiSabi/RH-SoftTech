{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EasyM - Mes Demandes de Congés{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/logo/Onian-EasyM.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/absence.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/dossier_individuel_base.css' %}">

</head>
<body data-employe-uuid="{% if employe %}{{ employe.uuid }}{% endif %}">
<!-- Header -->
{% include 'base/header.html' %}

<div class="content">
    <div class="content-header">
        <div class="employee-info">
            <div><h1><i class="fas fa-user-check"></i> Validation Manager - Congés et Absences</h1></div>
            <br>
            <p class="employee-subtitle">
                Manager {{departement.LIBELLE }} |
                {% if departement.STATUT %}
                <span class="badge badge-success">Actif</span>
                {% else %}
                <span class="badge badge-danger">Inactif</span>
                {% endif %}
            </p>
        </div>
    </div>

    <div class="stats-cards">
        <div class="stat-card en-attente">
            <i class="fas fa-clock"></i>
            <h3>En Attente</h3>
            <div class="number">{{ stats.en_attente }}</div>
        </div>
        <div class="stat-card validees">
            <i class="fas fa-check-circle"></i>
            <h3>Validées ce mois</h3>
            <div class="number">{{ stats.validees }}</div>
        </div>
        <div class="stat-card refusees">
            <i class="fas fa-times-circle"></i>
            <h3>Refusées ce mois</h3>
            <div class="number">{{ stats.refusees }}</div>
        </div>
        <div class="stat-card equipe">
            <i class="fas fa-users"></i>
            <h3>Équipe</h3>
            <div class="number">{{ stats.equipe_total }}</div>
        </div>
    </div>

    <div class="filtres-section">
        <div class="filtres-header">
            <h3>
                <i class="fas fa-filter"></i>
                Filtres
                {% if filtre_employe or filtre_type %}
                <span class="badge-filtre-actif">
                    <i class="fas fa-check-circle"></i>
                    Actifs
                </span>
                {% endif %}
            </h3>
        </div>

    <form method="GET" id="formFiltres">
        <div class="filtres-grid">
            <!-- Filtre Employé -->
            <div class="filtre-group">
                <label for="filtre_employe">
                    <i class="fas fa-user"></i> Employé
                </label>
                <input type="text"
                       id="filtre_employe"
                       name="employe"
                       value="{{ filtre_employe }}"
                       placeholder="Matricule, nom ou prénom..."
                       autocomplete="off">
            </div>

            <!-- Filtre Type d'absence -->
            <div class="filtre-group">
                <label for="filtre_type">
                    <i class="fas fa-tags"></i> Type d'absence
                </label>
                <select id="filtre_type" name="type">
                    <option value="">Tous les types</option>
                    {% for type in types_absence %}
                        <option value="{{ type.pk }}" {% if filtre_type == type.pk|stringformat:"s" %}selected{% endif %}>
                            {{ type.LIBELLE }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="filtres-actions">
            <button type="submit" class="btn-filtrer">
                <i class="fas fa-search"></i>
                Appliquer les filtres
            </button>
            <button type="button" class="btn-reinitialiser" onclick="reinitialiserFiltres()">
                <i class="fas fa-redo"></i>
                Réinitialiser
            </button>
        </div>
    </form>
</div>

<!-- Message si filtres actifs -->
{% if filtre_employe or filtre_type %}
<div class="message-filtres-actifs">
    <div class="content">
        <i class="fas fa-info-circle"></i>
        <strong>Filtres actifs :</strong>
        {% if filtre_employe %}
            <span class="filtre-tag">
                Employé: "{{ filtre_employe }}"
            </span>
        {% endif %}
        {% if filtre_type %}
            {% for type in types_absence %}
                {% if type.pk|stringformat:"s" == filtre_type %}
                    <span class="filtre-tag">
                        Type: "{{ type.LIBELLE }}"
                    </span>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
</div>
{% endif %}

    <div class="main-content-abs">
        <div>
            <div class="tabs-container-manager">
    <div class="tabs-header-manager">
        <button class="tab-button-manager {% if onglet_actif == 'a_valider' %}active{% endif %}"
                onclick="changeTabManager('a_valider')"
                data-tab="a_valider">
            <i class="fas fa-clock"></i>
            À valider
            <span class="tab-badge-manager">{{ count_a_valider }}</span>
        </button>

        <button class="tab-button-manager {% if onglet_actif == 'validees' %}active{% endif %}"
                onclick="changeTabManager('validees')"
                data-tab="validees">
            <i class="fas fa-check-circle"></i>
            Validées
            <span class="tab-badge-manager">{{ count_validees }}</span>
        </button>

        <button class="tab-button-manager {% if onglet_actif == 'refusees' %}active{% endif %}"
                onclick="changeTabManager('refusees')"
                data-tab="refusees">
            <i class="fas fa-times-circle"></i>
            Refusées
            <span class="tab-badge-manager">{{ count_refusees }}</span>
        </button>
    </div>

    <!-- ONGLET 1 : À VALIDER -->
    <div class="tab-content-manager {% if onglet_actif == 'a_valider' %}active{% endif %}"
         id="tab-a-valider"
         data-tab-content="a_valider">
        {% if demandes_a_valider %}
            {% for demande in demandes_a_valider %}
            <div class="demande-card {% if demande.est_urgent %}urgente{% endif %}">
                {% if demande.est_urgent %}
                <div style="color: #ef4444; font-weight: 600; margin-bottom: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> Demande urgente
                </div>
                {% endif %}

                <div class="demande-header">
                    <div class="demande-employe">
                        <div class="avatar-small">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                        <div class="employe-info">
                            <h4>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h4>
                            <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                        </div>
                    </div>
                    <span class="demande-type-badge {{ demande.type_absence.CODE|lower }}">
                        {{ demande.type_absence.LIBELLE }}
                    </span>
                </div>

                <div class="demande-details">
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-calendar"></i> Période</span>
                        <span class="detail-value">{{ demande.date_debut|date:"d/m/Y" }} - {{ demande.date_fin|date:"d/m/Y" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-clock"></i> Durée</span>
                        <span class="detail-value">
                            {{ demande.nombre_jours|floatformat:1 }} jour{{ demande.nombre_jours|floatformat:1|pluralize }}
                            {% if demande.duree == 'DEMI' %}
                                ({% if demande.periode == 'MATIN' %}matin{% else %}après-midi{% endif %})
                            {% endif %}
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-paper-plane"></i> Demandé le</span>
                        <span class="detail-value">{{ demande.created_at|date:"d/m/Y" }}</span>
                    </div>

                    {% if demande.justificatif %}
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-paperclip"></i> Justificatif</span>
                        <span class="detail-value">
                            <a href="{{ demande.justificatif.url }}" target="_blank" class="btn-download">
                                <i class="fas fa-download"></i> Télécharger
                            </a>
                        </span>
                    </div>
                    {% endif %}
                </div>

                {% if demande.motif %}
                <div class="demande-motif">
                    <i class="fas fa-comment"></i> {{ demande.motif }}
                </div>
                {% endif %}

                <div class="demande-actions">
                    <button class="btn btn-success"
                            onclick="validerDemande('{{ demande.id }}', '{{ demande.numero_demande }}')">
                        <i class="fas fa-check"></i> Valider
                    </button>
                    <button class="btn btn-danger"
                            onclick="ouvrirModalRefus('{{ demande.id }}', '{{ demande.numero_demande }}')">
                        <i class="fas fa-times"></i> Refuser
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-manager">
                <i class="fas fa-check-circle"></i>
                <h3>Aucune demande à valider</h3>
                <p>Toutes les demandes ont été traitées</p>
            </div>
        {% endif %}
    </div>

    <!-- ONGLET 2 : VALIDÉES -->
    <div class="tab-content-manager {% if onglet_actif == 'validees' %}active{% endif %}"
         id="tab-validees"
         data-tab-content="validees">
        {% if demandes_validees %}
            {% for demande in demandes_validees %}
            <div class="demande-card">
                <div class="demande-header">
                    <div class="demande-employe">
                        <div class="avatar-small">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                        <div class="employe-info">
                            <h4>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h4>
                            <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                        </div>
                    </div>
                    <span class="demande-type-badge {{ demande.type_absence.CODE|lower }}">
                        {{ demande.type_absence.LIBELLE }}
                    </span>
                </div>

                <div class="demande-details">
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-calendar"></i> Période</span>
                        <span class="detail-value">{{ demande.date_debut|date:"d/m/Y" }} - {{ demande.date_fin|date:"d/m/Y" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-clock"></i> Durée</span>
                        <span class="detail-value">{{ demande.nombre_jours|floatformat:1 }} jour(s)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-check-circle"></i> Validée le</span>
                        <span class="detail-value">{{ demande.date_validation_manager|date:"d/m/Y" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-info-circle"></i> Statut actuel</span>
                        <span class="detail-value">
                            {% if demande.statut == 'VALIDEE_MANAGER' %}
                                <span style="color: #f59e0b;">En attente validation RH</span>
                            {% elif demande.statut == 'VALIDEE_RH' %}
                                <span style="color: #10b981;">✓ Validée RH</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                {% if demande.motif %}
                <div class="demande-motif">
                    <i class="fas fa-comment"></i> {{ demande.motif }}
                </div>
                {% endif %}

                {% if demande.commentaire_manager %}
                <div style="margin-top: 10px; padding: 10px; background: #d1fae5; border-radius: 6px; font-size: 13px;">
                    <strong style="color: #065f46;"><i class="fas fa-comment-dots"></i> Votre commentaire :</strong>
                    <p style="color: #065f46; margin: 5px 0 0 0;">{{ demande.commentaire_manager }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-manager">
                <i class="fas fa-check-circle"></i>
                <h3>Aucune demande validée</h3>
                <p>Vos demandes validées apparaîtront ici</p>
            </div>
        {% endif %}
    </div>

    <!-- ONGLET 3 : REFUSÉES -->
    <div class="tab-content-manager {% if onglet_actif == 'refusees' %}active{% endif %}"
         id="tab-refusees"
         data-tab-content="refusees">
        {% if demandes_refusees %}
            {% for demande in demandes_refusees %}
            <div class="demande-card">
                <div class="demande-header">
                    <div class="demande-employe">
                        <div class="avatar-small">{{ demande.employe.nom.0 }}{{ demande.employe.prenoms.0 }}</div>
                        <div class="employe-info">
                            <h4>{{ demande.employe.nom }} {{ demande.employe.prenoms }}</h4>
                            <p>{{ demande.employe.affectations.first.poste.LIBELLE|default:"Employé" }}</p>
                        </div>
                    </div>
                    <span class="demande-type-badge {{ demande.type_absence.CODE|lower }}">
                        {{ demande.type_absence.LIBELLE }}
                    </span>
                </div>

                <div class="demande-details">
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-calendar"></i> Période</span>
                        <span class="detail-value">{{ demande.date_debut|date:"d/m/Y" }} - {{ demande.date_fin|date:"d/m/Y" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-clock"></i> Durée</span>
                        <span class="detail-value">{{ demande.nombre_jours|floatformat:1 }} jour(s)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-times-circle"></i> Refusée le</span>
                        <span class="detail-value">{{ demande.date_validation_manager|date:"d/m/Y" }}</span>
                    </div>
                </div>

                {% if demande.motif %}
                <div class="demande-motif">
                    <i class="fas fa-comment"></i> <strong>Motif de l'employé :</strong> {{ demande.motif }}
                </div>
                {% endif %}

                {% if demande.motif_refus_manager %}
                <div style="margin-top: 10px; padding: 10px; background: #fee2e2; border-radius: 6px; border-left: 4px solid #ef4444; font-size: 13px;">
                    <strong style="color: #991b1b;"><i class="fas fa-times-circle"></i> Motif du refus :</strong>
                    <p style="color: #991b1b; margin: 5px 0 0 0;">{{ demande.motif_refus_manager }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-manager">
                <i class="fas fa-times-circle"></i>
                <h3>Aucune demande refusée</h3>
                <p>Vos demandes refusées apparaîtront ici</p>
            </div>
        {% endif %}
    </div>
</div>
        </div>

        <div>
            <div class="equipe-section">
                <h2><i class="fas fa-users"></i> Mon Équipe</h2>
                <div id="listeEquipe">
                    {% for membre in equipe_avec_statut %}
                    <div class="equipe-membre">
                        <div class="equipe-membre-info">
                            <div class="avatar-tiny">{{ membre.employe.nom.0 }}{{ membre.employe.prenoms.0 }}</div>
                            <div class="equipe-membre-name">{{ membre.employe.nom }} {{ membre.employe.prenoms }}</div>
                        </div>
                        <span class="equipe-membre-status {{ membre.statut }}">
                            {% if membre.statut == 'present' %}Présent
                            {% elif membre.statut == 'absent' %}Absent
                            {% elif membre.statut == 'conge' %}En congé
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal de refus -->
<div id="modalRefus" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-times-circle" style="color: #ef4444;"></i> Refuser la demande</h2>
            <span class="close" onclick="fermerModalRefus()">&times;</span>
        </div>
        <div class="form-group">
            <label>Motif du refus *</label>
            <textarea id="motifRefus" placeholder="Veuillez expliquer la raison du refus..."></textarea>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="fermerModalRefus()">Annuler</button>
            <button class="btn btn-danger" onclick="confirmerRefus()">
                <i class="fas fa-times"></i> Confirmer le refus
            </button>
        </div>
    </div>
</div>
<script src="{% static 'assets/js/main.js' %}"></script>
<script>
    let demandeEnCoursRefus = null;
    let numeroDemandeEnCours = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function validerDemande(demandeId, numeroDemande) {
        if (!confirm(`Voulez-vous valider la demande ?`)) {
            return;
        }

        const csrftoken = getCookie('csrftoken');

        fetch(`{% url 'absence:manager_valider_demande' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', demandeId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'commentaire='
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la validation');
        });
    }

    function ouvrirModalRefus(demandeId, numeroDemande) {
        demandeEnCoursRefus = demandeId;
        numeroDemandeEnCours = numeroDemande;
        document.getElementById('motifRefus').value = '';
        document.getElementById('modalRefus').style.display = 'block';
    }

    function fermerModalRefus() {
        document.getElementById('modalRefus').style.display = 'none';
        demandeEnCoursRefus = null;
        numeroDemandeEnCours = null;
    }

    function confirmerRefus() {
        const motif = document.getElementById('motifRefus').value.trim();

        if (!motif) {
            alert('Veuillez saisir un motif de refus');
            return;
        }

        const csrftoken = getCookie('csrftoken');

        fetch(`{% url 'absence:manager_refuser_demande' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', demandeEnCoursRefus), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `motif_refus=${encodeURIComponent(motif)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                fermerModalRefus();
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors du refus');
        });
    }

    // Fermer le modal en cliquant en dehors
    window.onclick = function(event) {
        const modal = document.getElementById('modalRefus');
        if (event.target === modal) {
            fermerModalRefus();
        }
    }

/**
 * Changer d'onglet SANS rechargement (Solution 2)
 */
function changeTabManager(tabName) {
    // Retirer 'active' de tous les éléments
    document.querySelectorAll('.tab-button-manager').forEach(btn => {
        btn.classList.remove('active');
    });

    document.querySelectorAll('.tab-content-manager').forEach(content => {
        content.classList.remove('active');
    });

    // Ajouter 'active' aux éléments sélectionnés
    const selectedButton = document.querySelector(`.tab-button-manager[data-tab="${tabName}"]`);
    const selectedContent = document.querySelector(`.tab-content-manager[data-tab-content="${tabName}"]`);

    if (selectedButton) selectedButton.classList.add('active');
    if (selectedContent) selectedContent.classList.add('active');

    // Mettre à jour l'URL (optionnel)
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('onglet', tabName);
    window.history.pushState({}, '', newUrl);
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const ongletActif = urlParams.get('onglet') || 'a_valider';
    changeTabManager(ongletActif);
});

// Gérer le bouton précédent/suivant
window.addEventListener('popstate', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const ongletActif = urlParams.get('onglet') || 'a_valider';
    changeTabManager(ongletActif);
});

    /**
     * Réinitialiser les filtres
     */
    function reinitialiserFiltres() {
        // Rediriger vers la page sans paramètres
        window.location.href = window.location.pathname;
    }
</script>
</body>
</html>