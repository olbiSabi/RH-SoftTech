{% extends 'base/baseSansMatricule.html' %}
{% load static %}
{% block extrastylet %}
<link rel="stylesheet" href="{% static 'assets/css/project_management/projet.css' %}">
{% endblock %}

{% block pageContent %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="pm-page-header">
        <div class="pm-breadcrumb">
            <a href="{% url 'pm:projet_list' %}"><i class="fas fa-project-diagram"></i> Projets</a>
            <i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i>
            <span>{% if form.instance.pk %}Modifier {{ form.instance.code }}{% else %}Nouveau projet{% endif %}</span>
        </div>
        <h1>
            <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %}"></i>
            {% if form.instance.pk %}Modifier le projet{% else %}Créer un nouveau projet{% endif %}
        </h1>
    </div>

    <form method="post">
        {% csrf_token %}

        <div class="pm-card">
            <div class="pm-card-header">
                <h2><i class="fas fa-info-circle"></i> Informations générales</h2>
            </div>
            <div class="pm-card-body">
                <div class="pm-form-grid">
                    <div class="pm-form-group full-width">
                        <label for="id_nom">Nom <span class="required">*</span></label>
                        {{ form.nom }}
                        {% if form.nom.errors %}
                            <div class="pm-form-error">{{ form.nom.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="pm-form-group full-width">
                        <label for="id_description">Description</label>
                        {{ form.description }}
                    </div>

                    <div class="pm-form-group">
                        <label for="id_client">Client</label>
                        {{ form.client }}
                    </div>

                    <div class="pm-form-group">
                        <label for="id_statut">Statut</label>
                        {{ form.statut }}
                    </div>
                </div>
            </div>
        </div>

        <div class="pm-card">
            <div class="pm-card-header">
                <h2><i class="fas fa-calendar-alt"></i> Planification</h2>
            </div>
            <div class="pm-card-body">
                <div class="pm-form-grid">
                    <div class="pm-form-group">
                        <label for="id_date_debut">Date de début <span class="required">*</span></label>
                        {{ form.date_debut }}
                        {% if form.date_debut.errors %}
                            <div class="pm-form-error">{{ form.date_debut.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="pm-form-group">
                        <label for="id_date_fin_prevue">Date de fin prévue <span class="required">*</span></label>
                        {{ form.date_fin_prevue }}
                        {% if form.date_fin_prevue.errors %}
                            <div class="pm-form-error">{{ form.date_fin_prevue.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="pm-form-group">
                        <label for="id_montant_total">Montant total (FCFA)</label>
                        {{ form.montant_total }}
                    </div>
                </div>
            </div>
        </div>

        <div class="pm-card">
            <div class="pm-card-header">
                <h2><i class="fas fa-users"></i> Équipe</h2>
            </div>
            <div class="pm-card-body">
                <div class="pm-form-grid">
                    <div class="pm-form-group">
                        <label for="chef_projet_search">Chef de projet</label>
                        <div class="pm-autocomplete-wrapper" id="chefProjetAutocomplete">
                            <input type="text"
                                   id="chef_projet_search"
                                   class="pm-autocomplete-input"
                                   placeholder="Rechercher un employé..."
                                   autocomplete="off">
                            <button type="button" class="pm-autocomplete-clear" id="clearChefProjet">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="pm-autocomplete-dropdown" id="chefProjetDropdown"></div>
                            <input type="hidden" name="chef_projet" id="id_chef_projet" value="{{ form.chef_projet.value|default:'' }}">
                        </div>
                        <div id="selectedChefProjet"></div>
                        {% if form.chef_projet.errors %}
                            <div class="pm-form-error">{{ form.chef_projet.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if form.instance.pk and form.instance.code %}
        <div class="pm-card">
            <div class="pm-card-header">
                <h2><i class="fas fa-history"></i> Informations système</h2>
            </div>
            <div class="pm-card-body">
                <div class="pm-form-grid">
                    <div class="pm-form-group">
                        <label>Code</label>
                        <input type="text" class="pm-form-control" value="{{ form.instance.code }}" disabled>
                    </div>
                    <div class="pm-form-group">
                        <label>Créé le</label>
                        <input type="text" class="pm-form-control" value="{{ form.instance.created_at|date:'d/m/Y H:i' }}" disabled>
                    </div>
                    <div class="pm-form-group">
                        <label>Tickets</label>
                        <input type="text" class="pm-form-control" value="{{ form.instance.tickets.count }} ticket(s)" disabled>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="pm-form-actions">
            <a href="{% if form.instance.pk and form.instance.code %}{% url 'pm:projet_detail' form.instance.pk %}{% else %}{% url 'pm:projet_list' %}{% endif %}" class="pm-btn pm-btn-secondary pm-btn-lg">
                <i class="fas fa-times"></i> Annuler
            </a>
            <button type="submit" class="pm-btn pm-btn-primary pm-btn-lg">
                <i class="fas fa-save"></i> {% if form.instance.pk %}Enregistrer{% else %}Créer le projet{% endif %}
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block extrascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply form-control class to form elements
    document.querySelectorAll('.pm-card-body input[type="text"], .pm-card-body input[type="number"], .pm-card-body input[type="date"], .pm-card-body select, .pm-card-body textarea').forEach(function(el) {
        if (!el.classList.contains('pm-form-control') && !el.classList.contains('pm-autocomplete-input')) {
            el.classList.add('pm-form-control');
        }
    });

    // Autocomplete for Chef de Projet
    const searchInput = document.getElementById('chef_projet_search');
    const dropdown = document.getElementById('chefProjetDropdown');
    const hiddenInput = document.getElementById('id_chef_projet');
    const wrapper = document.getElementById('chefProjetAutocomplete');
    const clearBtn = document.getElementById('clearChefProjet');
    const selectedContainer = document.getElementById('selectedChefProjet');

    let searchTimeout = null;
    let activeIndex = -1;

    // Load initial value if exists
    {% if form.instance.chef_projet %}
    const initialChef = {
        id: "{{ form.instance.chef_projet.matricule }}",
        nom: "{{ form.instance.chef_projet.nom }}",
        prenoms: "{{ form.instance.chef_projet.prenoms|default:'' }}",
        matricule: "{{ form.instance.chef_projet.matricule }}"
    };
    displaySelectedEmployee(initialChef);
    {% endif %}

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        if (query.length < 2) {
            dropdown.classList.remove('show');
            return;
        }

        searchTimeout = setTimeout(() => {
            fetchEmployees(query);
        }, 300);
    });

    searchInput.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.pm-autocomplete-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = Math.min(activeIndex + 1, items.length - 1);
            updateActiveItem(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = Math.max(activeIndex - 1, 0);
            updateActiveItem(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0 && items[activeIndex]) {
                items[activeIndex].click();
            }
        } else if (e.key === 'Escape') {
            dropdown.classList.remove('show');
        }
    });

    searchInput.addEventListener('focus', function() {
        if (this.value.length >= 2) {
            dropdown.classList.add('show');
        }
    });

    document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });

    clearBtn.addEventListener('click', function() {
        clearSelection();
    });

    function fetchEmployees(query) {
        dropdown.innerHTML = '<div class="pm-autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Recherche...</div>';
        dropdown.classList.add('show');

        fetch(`{% url 'pm:search_employes_api' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    dropdown.innerHTML = data.results.map((emp, index) => `
                        <div class="pm-autocomplete-item" data-id="${emp.id}" data-nom="${emp.nom}" data-prenoms="${emp.prenoms}" data-matricule="${emp.matricule}">
                            <div class="pm-autocomplete-avatar">
                                ${(emp.prenoms ? emp.prenoms[0] : '') + (emp.nom ? emp.nom[0] : '')}
                            </div>
                            <div class="pm-autocomplete-info">
                                <div class="pm-autocomplete-name">${emp.prenoms || ''} ${emp.nom || ''}</div>
                                <div class="pm-autocomplete-meta">${emp.matricule}</div>
                            </div>
                        </div>
                    `).join('');

                    // Add click handlers
                    dropdown.querySelectorAll('.pm-autocomplete-item').forEach(item => {
                        item.addEventListener('click', function() {
                            selectEmployee({
                                id: this.dataset.id,
                                nom: this.dataset.nom,
                                prenoms: this.dataset.prenoms,
                                matricule: this.dataset.matricule
                            });
                        });
                    });
                } else {
                    dropdown.innerHTML = '<div class="pm-autocomplete-empty">Aucun résultat trouvé</div>';
                }
                activeIndex = -1;
            })
            .catch(error => {
                console.error('Error:', error);
                dropdown.innerHTML = '<div class="pm-autocomplete-empty">Erreur lors de la recherche</div>';
            });
    }

    function updateActiveItem(items) {
        items.forEach((item, index) => {
            item.classList.toggle('active', index === activeIndex);
        });
    }

    function selectEmployee(emp) {
        hiddenInput.value = emp.id;
        searchInput.value = '';
        dropdown.classList.remove('show');
        wrapper.classList.add('has-value');
        displaySelectedEmployee(emp);
    }

    function displaySelectedEmployee(emp) {
        selectedContainer.innerHTML = `
            <div class="pm-selected-employee">
                <div class="pm-autocomplete-avatar">
                    ${(emp.prenoms ? emp.prenoms[0] : '') + (emp.nom ? emp.nom[0] : '')}
                </div>
                <div class="pm-autocomplete-info">
                    <div class="pm-autocomplete-name">${emp.prenoms || ''} ${emp.nom || ''}</div>
                    <div class="pm-autocomplete-meta">${emp.matricule}</div>
                </div>
                <button type="button" class="pm-remove-btn" onclick="clearChefProjetSelection()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        wrapper.classList.add('has-value');
    }

    function clearSelection() {
        hiddenInput.value = '';
        searchInput.value = '';
        selectedContainer.innerHTML = '';
        wrapper.classList.remove('has-value');
        searchInput.focus();
    }

    // Expose clearSelection globally
    window.clearChefProjetSelection = clearSelection;
});
</script>
{% endblock %}