{% extends 'base/baseSansMatricule.html' %}
{% load static %}

{% block title %}{{ ticket.code }} - {{ ticket.titre }}{% endblock %}

{% block extrastylet %}
<link rel="stylesheet" href="{% static 'assets/css/project_management/ticket.css' %}">
<style>
    /* Styles spécifiques à cette page seulement */
    .pm-ticket-code-header {
        font-family: monospace;
        background: rgba(255,255,255,0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block pageContent %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="pm-page-header">
        <div class="pm-breadcrumb">
            <a href="{% url 'pm:ticket_list' %}"><i class="fas fa-ticket-alt"></i> Tickets</a>
            <i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i>
            <span>{{ ticket.code }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1>
                    <span class="pm-ticket-code-header">{{ ticket.code }}</span>
                    {{ ticket.titre }}
                </h1>
                <div class="pm-header-badges">
                    <span class="pm-header-badge">
                        <i class="fas fa-tag"></i> {{ ticket.get_type_ticket_display }}
                    </span>
                    <span class="pm-header-badge">
                        <i class="fas fa-exclamation-circle"></i> {{ ticket.get_priorite_display }}
                    </span>
                    <span class="pm-header-badge">
                        <i class="fas fa-flag"></i> {{ ticket.get_statut_display }}
                    </span>
                    {% if ticket.projet %}
                    <span class="pm-header-badge">
                        <i class="fas fa-project-diagram"></i> {{ ticket.projet.nom }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'pm:ticket_update' ticket.pk %}" class="pm-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <button type="button" class="pm-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;" onclick="openDeleteModal()">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>

    <div class="pm-grid">
        <!-- Colonne principale -->
        <div>
            <!-- Description -->
            <div class="pm-card">
                <div class="pm-card-header">
                    <h2><i class="fas fa-align-left"></i> Description</h2>
                </div>
                <div class="pm-card-body">
                    <div class="pm-description">
                        {% if ticket.description %}
                            {{ ticket.description|linebreaks }}
                        {% else %}
                            <p style="color: var(--pm-gray-400); font-style: italic;">Aucune description</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tabs pour commentaires, pièces jointes, historique, imputations -->
            <div class="pm-card">
                <div class="pm-card-body" style="padding-bottom: 0;">
                    <div class="pm-tabs">
                        <a href="#" class="pm-tab active" data-tab="commentaires">
                            <i class="fas fa-comments"></i> Commentaires
                            <span class="pm-tab-badge">{{ commentaires.count }}</span>
                        </a>
                        <a href="#" class="pm-tab" data-tab="pieces-jointes">
                            <i class="fas fa-paperclip"></i> Pièces jointes
                            <span class="pm-tab-badge">{{ pieces_jointes.count }}</span>
                        </a>
                        <a href="#" class="pm-tab" data-tab="historique">
                            <i class="fas fa-history"></i> Historique
                        </a>
                        <a href="#" class="pm-tab" data-tab="imputations">
                            <i class="fas fa-clock"></i> Imputations
                            <span class="pm-tab-badge">{{ imputations.count }}</span>
                        </a>
                    </div>
                </div>

                <!-- Commentaires -->
                <div id="tab-commentaires" class="pm-tab-content active">
                    <div class="pm-card-body">
                        <!-- Formulaire d'ajout -->
                        <form method="post" action="{% url 'pm:ticket_commentaire' ticket.pk %}" class="pm-comment-form">
                            {% csrf_token %}
                            <textarea name="contenu" placeholder="Ajouter un commentaire..." required></textarea>
                            <button type="submit" class="pm-btn pm-btn-primary">
                                <i class="fas fa-paper-plane"></i> Envoyer
                            </button>
                        </form>

                        <!-- Liste des commentaires -->
                        {% for commentaire in commentaires %}
                        <div class="pm-comment">
                            <span class="pm-avatar pm-avatar-sm">
                                {{ commentaire.auteur.prenoms|slice:":1" }}{{ commentaire.auteur.nom|slice:":1" }}
                            </span>
                            <div class="pm-comment-content">
                                <div class="pm-comment-header">
                                    <span class="pm-comment-author">{{ commentaire.auteur.prenoms }} {{ commentaire.auteur.nom }}</span>
                                    <span class="pm-comment-date">{{ commentaire.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                                <div class="pm-comment-text">{{ commentaire.contenu|linebreaks }}</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="pm-empty">
                            <i class="fas fa-comments"></i>
                            <p>Aucun commentaire pour ce ticket</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Pièces jointes -->
                <div id="tab-pieces-jointes" class="pm-tab-content">
                    <div class="pm-card-body">
                        <!-- Formulaire d'ajout -->
                        <form method="post" action="{% url 'pm:ticket_piece_jointe' ticket.pk %}" enctype="multipart/form-data" style="margin-bottom: 1.5rem;">
                            {% csrf_token %}
                            <div style="display: flex; gap: 1rem; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <input type="file" name="fichier" class="pm-form-control" required>
                                </div>
                                <button type="submit" class="pm-btn pm-btn-primary">
                                    <i class="fas fa-upload"></i> Téléverser
                                </button>
                            </div>
                        </form>

                        {% for piece in pieces_jointes %}
                        <div class="pm-attachment">
                            <div class="pm-attachment-icon">
                                <i class="fas fa-file"></i>
                            </div>
                            <div class="pm-attachment-info">
                                <div class="pm-attachment-name">{{ piece.nom_original }}</div>
                                <div class="pm-attachment-meta">
                                    {{ piece.taille|filesizeformat }} ·
                                    {% if piece.uploaded_by %}{{ piece.uploaded_by.prenoms }} {{ piece.uploaded_by.nom }}{% endif %} ·
                                    {{ piece.uploaded_at|date:"d/m/Y H:i" }}
                                </div>
                            </div>
                            <a href="{{ piece.fichier.url }}" class="pm-btn pm-btn-secondary pm-btn-sm" download>
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                        {% empty %}
                        <div class="pm-empty">
                            <i class="fas fa-paperclip"></i>
                            <p>Aucune pièce jointe</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Historique -->
                <div id="tab-historique" class="pm-tab-content">
                    <div class="pm-card-body">
                        <div class="pm-timeline">
                            {% for hist in historique %}
                            <div class="pm-timeline-item">
                                <div class="pm-timeline-date">{{ hist.created_at|date:"d/m/Y H:i" }}</div>
                                <div class="pm-timeline-content">
                                    <span class="pm-timeline-author">
                                        {% if hist.utilisateur %}{{ hist.utilisateur.prenoms }} {{ hist.utilisateur.nom }}{% else %}Système{% endif %}
                                    </span>
                                    <br>{{ hist.description }}
                                </div>
                            </div>
                            {% empty %}
                            <div class="pm-empty">
                                <i class="fas fa-history"></i>
                                <p>Aucun historique</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Imputations -->
                <div id="tab-imputations" class="pm-tab-content">
                    <div class="pm-card-body">
                        {% for imputation in imputations %}
                        <div class="pm-imputation">
                            <div class="pm-imputation-left">
                                <span class="pm-avatar pm-avatar-sm">
                                    {{ imputation.employe.prenoms|slice:":1" }}{{ imputation.employe.nom|slice:":1" }}
                                </span>
                                <div>
                                    <strong>{{ imputation.employe.prenoms }} {{ imputation.employe.nom }}</strong>
                                    <br>
                                    <small style="color: var(--pm-gray-500);">{{ imputation.date_imputation|date:"d/m/Y" }}</small>
                                </div>
                            </div>
                            <div class="pm-imputation-hours">
                                {{ imputation.heures_travaillees }} <small>h</small>
                            </div>
                        </div>
                        {% empty %}
                        <div class="pm-empty">
                            <i class="fas fa-clock"></i>
                            <p>Aucune imputation sur ce ticket</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne latérale -->
        <div>
            <!-- Informations -->
            <div class="pm-card">
                <div class="pm-card-header">
                    <h2><i class="fas fa-info-circle"></i> Informations</h2>
                </div>
                <div class="pm-card-body">
                    <div class="pm-info-grid">
                        <div class="pm-info-item">
                            <label>Statut</label>
                            <span class="pm-badge pm-badge-statut-{{ ticket.statut|lower }}">
                                {{ ticket.get_statut_display }}
                            </span>
                        </div>
                        <div class="pm-info-item">
                            <label>Priorité</label>
                            <span class="pm-badge pm-badge-priorite-{{ ticket.priorite|lower }}">
                                {{ ticket.get_priorite_display }}
                            </span>
                        </div>
                        <div class="pm-info-item">
                            <label>Type</label>
                            <span class="pm-badge pm-badge-type-{{ ticket.type_ticket|lower }}">
                                {{ ticket.get_type_ticket_display }}
                            </span>
                        </div>
                        <div class="pm-info-item">
                            <label>Créé le</label>
                            <span>{{ ticket.created_at|date:"d/m/Y H:i" }}</span>
                        </div>
                        <div class="pm-info-item" style="grid-column: span 2;">
                            <label>Projet</label>
                            {% if ticket.projet %}
                                {% if peut_gerer_projets %}
                                <a href="{% url 'pm:projet_detail' ticket.projet.pk %}">
                                    {{ ticket.projet.nom }}
                                </a>
                                {% else %}
                                <span>{{ ticket.projet.nom }}</span>
                                {% endif %}
                            {% else %}
                            <span style="color: var(--pm-gray-400);">Non assigné</span>
                            {% endif %}
                        </div>
                        {% if ticket.date_echeance %}
                        <div class="pm-info-item" style="grid-column: span 2;">
                            <label>Date d'échéance</label>
                            <span {% if ticket.date_echeance < today %}style="color: var(--pm-danger);"{% endif %}>
                                {{ ticket.date_echeance|date:"d/m/Y" }}
                            </span>
                        </div>
                        {% endif %}
                        {% if ticket.estimation_heures %}
                        <div class="pm-info-item">
                            <label>Estimation</label>
                            <span>{{ ticket.estimation_heures }}h</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Changer le statut rapidement -->
                    <div class="pm-quick-actions">
                        <span style="font-size: 0.8rem; color: var(--pm-gray-500); width: 100%; margin-bottom: 0.5rem;">Changer le statut :</span>
                        <form method="post" action="{% url 'pm:ticket_changer_statut' ticket.pk %}" style="display: contents;" id="statusForm">
                            {% csrf_token %}
                            <button type="submit" name="statut" value="OUVERT" class="pm-status-btn {% if ticket.statut == 'OUVERT' %}active{% endif %}">
                                Ouvert
                            </button>
                            <button type="submit" name="statut" value="EN_COURS" class="pm-status-btn {% if ticket.statut == 'EN_COURS' %}active{% endif %}">
                                En cours
                            </button>
                            <button type="submit" name="statut" value="EN_REVUE" class="pm-status-btn {% if ticket.statut == 'EN_REVUE' %}active{% endif %}">
                                En revue
                            </button>
                            <button type="submit" name="statut" value="TERMINE" class="pm-status-btn {% if ticket.statut == 'TERMINE' %}active{% endif %}">
                                Terminé
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Assignation -->
            <div class="pm-card">
                <div class="pm-card-header">
                    <h2><i class="fas fa-user"></i> Assigné à</h2>
                </div>
                <div class="pm-card-body">
                    <form method="post" action="{% url 'pm:ticket_assigner' ticket.pk %}" id="assigneForm">
                        {% csrf_token %}
                        <div class="pm-autocomplete-wrapper" id="assigneAutocomplete">
                            <input type="text"
                                   id="assigne_search"
                                   class="pm-autocomplete-input"
                                   placeholder="Rechercher un employé..."
                                   autocomplete="off">
                            <button type="button" class="pm-autocomplete-clear" id="clearAssigne">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="pm-autocomplete-dropdown" id="assigneDropdown"></div>
                            <input type="hidden" name="assigne" id="id_assigne" value="{% if ticket.assigne %}{{ ticket.assigne.matricule }}{% endif %}">
                        </div>
                        <div id="selectedAssigne">
                            {% if ticket.assigne %}
                            <div class="pm-selected-employee">
                                <div class="pm-autocomplete-avatar">
                                    {{ ticket.assigne.prenoms|slice:":1" }}{{ ticket.assigne.nom|slice:":1" }}
                                </div>
                                <div class="pm-autocomplete-info">
                                    <div class="pm-autocomplete-name">{{ ticket.assigne.prenoms }} {{ ticket.assigne.nom }}</div>
                                    <div class="pm-autocomplete-meta">{{ ticket.assigne.fonction|default:"Employé" }}</div>
                                </div>
                                <button type="button" class="pm-remove-btn" onclick="clearAssigneSelection()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% else %}
                            <p style="color: var(--pm-gray-400); text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Non assigné</p>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sprint -->
            {% if ticket.sprint %}
            <div class="pm-card">
                <div class="pm-card-header">
                    <h2><i class="fas fa-running"></i> Sprint</h2>
                </div>
                <div class="pm-card-body">
                    <a href="{% url 'pm:sprint_detail' ticket.sprint.pk %}" style="color: var(--pm-primary); text-decoration: none; font-weight: 500;">
                        {{ ticket.sprint.nom }}
                    </a>
                    <p style="font-size: 0.85rem; color: var(--pm-gray-500); margin: 0.5rem 0 0;">
                        {{ ticket.sprint.date_debut|date:"d/m" }} - {{ ticket.sprint.date_fin|date:"d/m/Y" }}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de suppression -->
<div id="deleteModal" class="pm-modal-overlay">
    <div class="pm-modal">
        <div class="pm-modal-icon danger">
            <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem;"></i>
        </div>
        <h3>Supprimer ce ticket ?</h3>
        <p>Le ticket <strong>{{ ticket.code }}</strong> sera définitivement supprimé avec tous ses commentaires et pièces jointes.</p>
        <form method="post" action="{% url 'pm:ticket_delete' ticket.pk %}" class="pm-modal-actions">
            {% csrf_token %}
            <button type="button" onclick="closeDeleteModal()" class="pm-btn pm-btn-secondary">Annuler</button>
            <button type="submit" class="pm-btn pm-btn-danger">
                <i class="fas fa-trash"></i> Supprimer
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block extrascript %}
<script>
    // Tabs
    document.querySelectorAll('.pm-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.dataset.tab;

            // Désactiver tous les tabs
            document.querySelectorAll('.pm-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.pm-tab-content').forEach(c => c.classList.remove('active'));

            // Activer le tab cliqué
            this.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        });
    });

    // Modal de suppression
    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });

    // Autocomplete pour Assigné
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('assigne_search');
        const dropdown = document.getElementById('assigneDropdown');
        const hiddenInput = document.getElementById('id_assigne');
        const wrapper = document.getElementById('assigneAutocomplete');
        const clearBtn = document.getElementById('clearAssigne');
        const selectedContainer = document.getElementById('selectedAssigne');
        const form = document.getElementById('assigneForm');

        let searchTimeout = null;
        let activeIndex = -1;

        // Marquer comme has-value si déjà assigné
        {% if ticket.assigne %}
        wrapper.classList.add('has-value');
        {% endif %}

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            searchTimeout = setTimeout(() => {
                fetchEmployees(query);
            }, 300);
        });

        searchInput.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.pm-autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                updateActiveItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
                updateActiveItem(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeIndex >= 0 && items[activeIndex]) {
                    items[activeIndex].click();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
            }
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                dropdown.classList.add('show');
            }
        });

        document.addEventListener('click', function(e) {
            if (!wrapper.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        clearBtn.addEventListener('click', function() {
            clearSelection();
        });

        function fetchEmployees(query) {
            dropdown.innerHTML = '<div class="pm-autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Recherche...</div>';
            dropdown.classList.add('show');

            fetch(`{% url 'pm:search_employes_api' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        dropdown.innerHTML = data.results.map((emp, index) => `
                            <div class="pm-autocomplete-item" data-id="${emp.id}" data-nom="${emp.nom}" data-prenoms="${emp.prenoms}" data-matricule="${emp.matricule}" data-fonction="${emp.fonction || 'Employé'}">
                                <div class="pm-autocomplete-avatar">
                                    ${(emp.prenoms ? emp.prenoms[0] : '') + (emp.nom ? emp.nom[0] : '')}
                                </div>
                                <div class="pm-autocomplete-info">
                                    <div class="pm-autocomplete-name">${emp.prenoms || ''} ${emp.nom || ''}</div>
                                    <div class="pm-autocomplete-meta">${emp.matricule}</div>
                                </div>
                            </div>
                        `).join('');

                        // Add click handlers
                        dropdown.querySelectorAll('.pm-autocomplete-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selectEmployee({
                                    id: this.dataset.id,
                                    nom: this.dataset.nom,
                                    prenoms: this.dataset.prenoms,
                                    matricule: this.dataset.matricule,
                                    fonction: this.dataset.fonction
                                });
                            });
                        });
                    } else {
                        dropdown.innerHTML = '<div class="pm-autocomplete-empty">Aucun résultat trouvé</div>';
                    }
                    activeIndex = -1;
                })
                .catch(error => {
                    console.error('Error:', error);
                    dropdown.innerHTML = '<div class="pm-autocomplete-empty">Erreur lors de la recherche</div>';
                });
        }

        function updateActiveItem(items) {
            items.forEach((item, index) => {
                item.classList.toggle('active', index === activeIndex);
            });
        }

        function selectEmployee(emp) {
            hiddenInput.value = emp.id;
            searchInput.value = '';
            dropdown.classList.remove('show');
            wrapper.classList.add('has-value');
            displaySelectedEmployee(emp);
            // Soumettre le formulaire automatiquement
            form.submit();
        }

        function displaySelectedEmployee(emp) {
            selectedContainer.innerHTML = `
                <div class="pm-selected-employee">
                    <div class="pm-autocomplete-avatar">
                        ${(emp.prenoms ? emp.prenoms[0] : '') + (emp.nom ? emp.nom[0] : '')}
                    </div>
                    <div class="pm-autocomplete-info">
                        <div class="pm-autocomplete-name">${emp.prenoms || ''} ${emp.nom || ''}</div>
                        <div class="pm-autocomplete-meta">${emp.fonction || 'Employé'}</div>
                    </div>
                    <button type="button" class="pm-remove-btn" onclick="clearAssigneSelection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            wrapper.classList.add('has-value');
        }

        function clearSelection() {
            hiddenInput.value = '';
            searchInput.value = '';
            selectedContainer.innerHTML = '<p style="color: var(--pm-gray-400); text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Non assigné</p>';
            wrapper.classList.remove('has-value');
            searchInput.focus();
            // Soumettre pour retirer l'assignation
            form.submit();
        }

        // Expose clearSelection globally
        window.clearAssigneSelection = clearSelection;
    });
</script>
{% endblock %}