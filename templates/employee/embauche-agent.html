{% extends 'base/baseSansMatricule.html' %}
{% load static %}

{% block extrastylet %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .section-header {
            background-color: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #0d6efd;
        }
        .required::after {
            content: " *";
            color: red;
        }
        .message-container {
            position: sticky;
            top: 20px;
            z-index: 1000;
            margin-bottom: 20px;
        }
        .alert {
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
{% endblock %}

<!-- Content Body (Page Body) -->

{% block pageContent %}
<!-- Page Content -->
<div class="content container-fluid">
 <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1 class="mb-4">
                    <i class="bi bi-person-plus"></i> Embauche d'un Nouvel Agent
                </h1>

                <!-- Zone d'affichage des messages -->
                <div class="message-container">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {% if message.tags == 'success' %}
                                    <i class="bi bi-check-circle-fill"></i>
                                {% elif message.tags == 'error' or message.tags == 'danger' %}
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                {% elif message.tags == 'warning' %}
                                    <i class="bi bi-exclamation-circle-fill"></i>
                                {% else %}
                                    <i class="bi bi-info-circle-fill"></i>
                                {% endif %}
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <form method="post" novalidate id="embauche-form">
                    {% csrf_token %}

                    <!-- Informations personnelles -->
                    <div class="section-header">
                        <h4>Informations Personnelles</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.nom.id_for_label }}" class="form-label required">Nom</label>
                            {{ form.nom }}
                            {% if form.nom.errors %}
                                <div class="text-danger">{{ form.nom.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.prenoms.id_for_label }}" class="form-label required">Prénom(s)</label>
                            {{ form.prenoms }}
                            {% if form.prenoms.errors %}
                                <div class="text-danger">{{ form.prenoms.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.date_naissance.id_for_label }}" class="form-label required">Date de naissance</label>
                            {{ form.date_naissance }}
                            {% if form.date_naissance.errors %}
                                <div class="text-danger">{{ form.date_naissance.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.sexe.id_for_label }}" class="form-label required">Sexe</label>
                            {{ form.sexe }}
                            {% if form.sexe.errors %}
                                <div class="text-danger">{{ form.sexe.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.situation_familiale.id_for_label }}" class="form-label">Situation familiale</label>
                            {{ form.situation_familiale }}
                            {% if form.situation_familiale.errors %}
                                <div class="text-danger">{{ form.situation_familiale.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.ville_naissance.id_for_label }}" class="form-label">Ville de naissance</label>
                            {{ form.ville_naissance }}
                            {% if form.ville_naissance.errors %}
                                <div class="text-danger">{{ form.ville_naissance.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.pays_naissance.id_for_label }}" class="form-label">Pays de naissance</label>
                            {{ form.pays_naissance }}
                            {% if form.pays_naissance.errors %}
                                <div class="text-danger">{{ form.pays_naissance.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Pièce d'identité -->
                    <div class="section-header">
                        <h4>Pièce d'Identité</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.type_id.id_for_label }}" class="form-label required">Type d'identité</label>
                            {{ form.type_id }}
                            {% if form.type_id.errors %}
                                <div class="text-danger">{{ form.type_id.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.numero_id.id_for_label }}" class="form-label required">Numéro d'identité</label>
                            {{ form.numero_id }}
                            {% if form.numero_id.errors %}
                                <div class="text-danger">{{ form.numero_id.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_validite_id.id_for_label }}" class="form-label required">Date de validité ID</label>
                            {{ form.date_validite_id }}
                            {% if form.date_validite_id.errors %}
                                <div class="text-danger">{{ form.date_validite_id.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_expiration_id.id_for_label }}" class="form-label required">Date d'expiration ID</label>
                            {{ form.date_expiration_id }}
                            {% if form.date_expiration_id.errors %}
                                <div class="text-danger">{{ form.date_expiration_id.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Poste et Affectation -->
                    <div class="section-header">
                        <h4>Poste et Affectation</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.poste.id_for_label }}" class="form-label required">Poste</label>
                            {{ form.poste }}
                            {% if form.poste.errors %}
                                <div class="text-danger">{{ form.poste.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Contrat -->
                    <div class="section-header">
                        <h4>Contrat</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.type_contrat.id_for_label }}" class="form-label required">Type de contrat</label>
                            {{ form.type_contrat }}
                            {% if form.type_contrat.errors %}
                                <div class="text-danger">{{ form.type_contrat.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.date_debut_contrat.id_for_label }}" class="form-label required">Date de début</label>
                            {{ form.date_debut_contrat }}
                            {% if form.date_debut_contrat.errors %}
                                <div class="text-danger">{{ form.date_debut_contrat.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.date_fin_contrat.id_for_label }}" class="form-label">Date de fin</label>
                            {{ form.date_fin_contrat }}
                            {% if form.date_fin_contrat.errors %}
                                <div class="text-danger">{{ form.date_fin_contrat.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Coordonnées -->
                    <div class="section-header">
                        <h4>Coordonnées</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.numero_telephone.id_for_label }}" class="form-label required">Numéro de téléphone</label>
                            {{ form.numero_telephone }}
                            {% if form.numero_telephone.errors %}
                                <div class="text-danger">{{ form.numero_telephone.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label required">Email</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger">{{ form.email.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Adresse -->
                    <div class="section-header">
                        <h4>Adresse</h4>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.rue.id_for_label }}" class="form-label required">Rue</label>
                            {{ form.rue }}
                            {% if form.rue.errors %}
                                <div class="text-danger">{{ form.rue.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.ville.id_for_label }}" class="form-label required">Ville</label>
                            {{ form.ville }}
                            {% if form.ville.errors %}
                                <div class="text-danger">{{ form.ville.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.pays.id_for_label }}" class="form-label required">Pays</label>
                            {{ form.pays }}
                            {% if form.pays.errors %}
                                <div class="text-danger">{{ form.pays.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.code_postal.id_for_label }}" class="form-label ">Code postal</label>
                            {{ form.code_postal }}
                            {% if form.code_postal.errors %}
                                <div class="text-danger">{{ form.code_postal.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_debut_adresse.id_for_label }}" class="form-label required">Date de début d'occupation</label>
                            {{ form.date_debut_adresse }}
                            {% if form.date_debut_adresse.errors %}
                                <div class="text-danger">{{ form.date_debut_adresse.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.complement.id_for_label }}" class="form-label">Complement à l'adresse</label>
                            {{ form.complement }}
                            {% if form.complement.errors %}
                                <div class="text-danger">{{ form.complement.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Boutons -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="bi bi-check-circle"></i> Valider la pré-embauche
                            </button>
                            <a href="{% url 'dossier_individuel' %}" class="btn btn-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Annuler
                            </a>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <p class="text-muted"><small>Les champs marqués d'un <span class="text-danger">*</span> sont obligatoires.</small></p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- /Page Content -->
{% endblock %}

{% block extrascript %}
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Empêcher la double soumission et avertir avant de quitter avec des modifications non sauvegardées
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('embauche-form');
            const submitButton = document.getElementById('submit-btn');
            let formModified = false;

            // Détecter les modifications du formulaire
            const formInputs = form.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                input.addEventListener('change', function() {
                    formModified = true;
                });
                input.addEventListener('input', function() {
                    formModified = true;
                });
            });

            // Empêcher la double soumission
            form.addEventListener('submit', function(e) {
                // Marquer que le formulaire est en cours de soumission
                formModified = false;

                // Désactiver le bouton et afficher un spinner
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement en cours...';

                // Si la validation HTML5 échoue, réactiver le bouton après un court délai
                setTimeout(function() {
                    if (!form.checkValidity()) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="bi bi-check-circle"></i> Valider la pré-embauche';
                    }
                }, 100);
            });

            // Avertir avant de quitter si des modifications non sauvegardées
            window.addEventListener('beforeunload', function(e) {
                if (formModified) {
                    e.preventDefault();
                    e.returnValue = 'Vous avez des modifications non enregistrées. Voulez-vous vraiment quitter cette page ?';
                    return e.returnValue;
                }
            });

            // Auto-hide success messages after 5 seconds
            setTimeout(function() {
                var alerts = document.querySelectorAll('.alert-success');
                alerts.forEach(function(alert) {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });


        // Empêcher la re-soumission du formulaire lors de l'actualisation
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script>
{% endblock %}