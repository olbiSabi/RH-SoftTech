{% load static %}
<!-- Contenu Onglet 1: Donn√©es Agent -->
<div class="tab-content {% if request.GET.tab == 'donnees' or not request.GET.tab %}active{% endif %}"
     id="donnees">
    <div class="form-section">
        <h3>Informations Personnelles</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Nom</label>
                <input type="text" value="{{ employe.nom }}" readonly>
            </div>
            <div class="form-group">
                <label>Pr√©nom(s)</label>
                <input type="text" value="{{ employe.prenoms }}" readonly>
            </div>
            <div class="form-group">
                <label>Date de naissance</label>
                <input type="date" value="{{ employe.date_naissance|date:'Y-m-d' }}" readonly>
            </div>
            <div class="form-group">
                <label>Sexe</label>
                <input type="text" value="{{ employe.get_sexe_display }}" readonly>
            </div>
            <div class="form-group">
                <label>Lieu de naissance</label>
                <input type="text" value="{{ employe.ville_naissance }}" readonly>
            </div>
            <div class="form-group">
                <label>Pays de naissance</label>
                <input type="text" value="{{ employe.pays_naissance }}" readonly>
            </div>
            <div class="form-group">
                <label>Situation familiale</label>
                <input type="text" value="{{ employe.get_situation_familiale_display }}" readonly>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Pi√®ce d'Identit√©</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Type d'identit√©</label>
                <input type="text" value="{{ employe.get_type_id_display }}" readonly>
            </div>
            <div class="form-group">
                <label>Num√©ro d'identit√©</label>
                <input type="text" value="{{ employe.numero_id }}" readonly>
            </div>
            <div class="form-group">
                <label>Date de validit√©</label>
                <input type="date" value="{{ employe.date_validite_id|date:'Y-m-d' }}" readonly>
            </div>
            <div class="form-group">
                <label>Date d'expiration</label>
                <input type="date" value="{{ employe.date_expiration_id|date:'Y-m-d' }}" readonly>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Informations Administratives</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Type de dossier</label>
                <input type="text" value="{{ employe.get_type_dossier_display }}" readonly>
            </div>
            <div class="form-group">
                <label>Date de validation embauche</label>
                <input type="date"
                       value="{% if employe.date_validation_embauche %}{{ employe.date_validation_embauche|date:'Y-m-d' }}{% endif %}"
                       readonly>
            </div>
            <div class="form-group">
                <label>√âtat du dossier</label>
                <input type="text" value="{{ employe.get_etat_display }}" readonly>
            </div>
            <!-- NOUVEAU CHAMP : MANAGER -->
            <div class="form-group">
    <label>Manager responsable</label>
    {% with manager=employe.get_manager_responsable %}
        {% if manager %}
        <div class="manager-display">
            <div class="d-flex align-items-center">
                {% if manager.employe.photo %}
                <img src="{{ manager.employe.photo.url }}" alt="Photo manager"
                     class="rounded-circle me-2" width="32" height="32">
                {% else %}
                <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center"
                     style="width: 32px; height: 32px;">
                    <i class="fas fa-user text-white"></i>
                </div>
                {% endif %}
                <div>
                    <strong>{{ manager.employe.nom }} {{ manager.employe.prenoms }}</strong>
                    <br>
                    <small class="text-muted">
                        {{ manager.departement.LIBELLE }}
                        (depuis le {{ manager.date_debut|date:"d/m/Y" }})
                    </small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-muted">
            <i class="fas fa-exclamation-circle me-1"></i>
            Aucun manager d√©fini
        </div>
        {% endif %}
    {% endwith %}
</div>
        </div>
    </div>
</div>

<!-- Contenu Onglet 2: Coordonn√©es -->
<div class="tab-content {% if request.GET.tab == 'coordonnees' %}active{% endif %}" id="coordonnees">
    <!-- Section Adresses -->
    <div class="form-section">
        <div class="section-header">
            <h3>Adresses</h3>
            <button type="button" class="btn btn-primary" id="addAdresseBtn">
                <i class="fas fa-plus"></i> Ajouter une adresse
            </button>
        </div>
        {% if adresses %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Type</th>
                <th>Adresse compl√®te</th>
                <th>P√©riode</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for adresse in adresses %}
            <tr>
                <td>{{ adresse.get_type_adresse_display }}</td>
                <td>{{ adresse.rue }}, {{ adresse.code_postal }} {{ adresse.ville }}, {{ adresse.pays }}</td>
                <td>
                    Du {{ adresse.date_debut|date:"d/m/Y" }}
                    {% if adresse.date_fin %}
                    au {{ adresse.date_fin|date:"d/m/Y" }}
                    {% else %}
                    - En cours
                    {% endif %}
                </td>
                <td>
                    {% if adresse.actif %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-warning btn-sm edit-adresse-btn"
                                data-id="{{ adresse.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-adresse-btn"
                                data-id="{{ adresse.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucune adresse enregistr√©e</p>
        {% endif %}
    </div>

    <!-- Section T√©l√©phones -->
    <div class="form-section">
        <div class="section-header">
            <h3>T√©l√©phones</h3>
            <button type="button" class="btn btn-primary" id="addTelephoneBtn">
                <i class="fas fa-plus"></i> Ajouter un t√©l√©phone
            </button>
        </div>
        {% if telephones %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Num√©ro</th>
                <th>P√©riode de validit√©</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for tel in telephones %}
            <tr>
                <td>{{ tel.numero }}</td>
                <td>
                    Du {{ tel.date_debut_validite|date:"d/m/Y" }}
                    {% if tel.date_fin_validite %}
                    au {{ tel.date_fin_validite|date:"d/m/Y" }}
                    {% else %}
                    - En cours
                    {% endif %}
                </td>
                <td>
                    {% if tel.actif %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-warning btn-sm edit-telephone-btn"
                                data-id="{{ tel.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-telephone-btn"
                                data-id="{{ tel.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucun t√©l√©phone enregistr√©</p>
        {% endif %}
    </div>

    <!-- Section Emails -->
    <div class="form-section">
        <div class="section-header">
            <h3>Emails</h3>
            <button type="button" class="btn btn-primary" id="addEmailBtn">
                <i class="fas fa-plus"></i> Ajouter un email
            </button>
        </div>
        {% if emails %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Email</th>
                <th>P√©riode de validit√©</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for email in emails %}
            <tr>
                <td>{{ email.email }}</td>
                <td>
                    Du {{ email.date_debut_validite|date:"d/m/Y" }}
                    {% if email.date_fin_validite %}
                    au {{ email.date_fin_validite|date:"d/m/Y" }}
                    {% else %}
                    - En cours
                    {% endif %}
                </td>
                <td>
                    {% if email.actif %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-warning btn-sm edit-email-btn"
                                data-id="{{ email.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-email-btn"
                                data-id="{{ email.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucun email enregistr√©</p>
        {% endif %}
    </div>
</div>

<!-- Contenu Onglet 3: Contrats & Affectations -->
<div class="tab-content {% if request.GET.tab == 'contrats' %}active{% endif %}" id="contrats">
    <div class="form-section">
        <div class="section-header">
            <h3>Contrats</h3>
            <button type="button" class="btn btn-primary" id="addContratBtn">
                <i class="fas fa-plus"></i> Ajouter un contrat
            </button>
        </div>
        {% if contrats %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Type de contrat</th>
                <th>Date de d√©but</th>
                <th>Date de fin</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for contrat in contrats %}
            <tr>
                <td>{{ contrat.get_type_contrat_display }}</td>
                <td>{{ contrat.date_debut|date:"d/m/Y" }}</td>
                <td>
                    {% if contrat.date_fin %}
                    {{ contrat.date_fin|date:"d/m/Y" }}
                    {% else %}
                    En cours
                    {% endif %}
                </td>
                <td>
                    {% if contrat.actif %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-warning btn-sm edit-contrat-btn"
                                data-id="{{ contrat.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-contrat-btn"
                                data-id="{{ contrat.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucun contrat enregistr√©</p>
        {% endif %}
    </div>

    <div class="form-section">
        <div class="section-header">
            <h3>Affectations</h3>
            <button type="button" class="btn btn-primary" id="addAffectationBtn">
                <i class="fas fa-plus"></i> Ajouter une affectation
            </button>
        </div>
        {% if affectations %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Poste</th>
                <th>D√©partement</th>
                <th>Date de d√©but</th>
                <th>Date de fin</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for affectation in affectations %}
            <tr>
                <td>{{ affectation.poste.LIBELLE }}</td>
                <td>{{ affectation.poste.DEPARTEMENT.LIBELLE }}</td>
                <td>{{ affectation.date_debut|date:"d/m/Y" }}</td>
                <td>
                    {% if affectation.date_fin %}
                    {{ affectation.date_fin|date:"d/m/Y" }}
                    {% else %}
                    En cours
                    {% endif %}
                </td>
                <td>
                    {% if affectation.actif %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-warning btn-sm edit-affectation-btn"
                                data-id="{{ affectation.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-affectation-btn"
                                data-id="{{ affectation.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucune affectation enregistr√©e</p>
        {% endif %}
    </div>
</div>

<!-- Contenu Onglet 4: Famille -->
<div class="tab-content {% if request.GET.tab == 'famille' %}active{% endif %}" id="famille">

    <!-- Section unique pour toutes les personnes √† charge -->
    <div class="form-section">
        <div class="section-header">
            <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Personnes √† charge</h3>
            <button type="button" class="btn btn-primary" id="addFamilleBtn">
                <i class="fas fa-plus"></i> Ajouter une personne √† charge
            </button>
        </div>

        {% if employe.personnes_charge.all %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Type</th>
                <th>Nom</th>
                <th>Pr√©nom</th>
                <th>Sexe</th>
                <th>Date de naissance</th>
                <th>D√©but prise en charge</th>
                <th>Fin prise en charge</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for personne in employe.personnes_charge.all %}
            <tr>
                <td>
                    {% if personne.personne_charge == 'ENFANT' %}üë∂
                    {% elif personne.personne_charge == 'CONJOINT' %}üíë
                    {% elif personne.personne_charge == 'PARENT' %}üëµ
                    {% else %}üë§{% endif %}
                    {{ personne.get_personne_charge_display }}
                </td>
                <td>{{ personne.nom }}</td>
                <td>{{ personne.prenom }}</td>
                <td>{{ personne.get_sexe_display }}</td>
                <td>{{ personne.date_naissance|date:"d/m/Y" }}</td>
                <td>{{ personne.date_debut_prise_charge|date:"d/m/Y" }}</td>
                <td>
                    {% if personne.date_fin_prise_charge %}
                    {{ personne.date_fin_prise_charge|date:"d/m/Y" }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if personne.actif %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-warning btn-sm edit-famille-btn"
                                data-id="{{ personne.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-famille-btn"
                                data-id="{{ personne.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucune personne √† charge enregistr√©e</p>
        {% endif %}
    </div>

    <!-- Statistiques Famille CORRIG√âES -->
    <div class="form-section">
    <div class="section-header">
        <h3>R√©capitulatif</h3>
    </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ nb_total }}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ nb_enfants }}</div>
                <div class="stat-label">Enfants</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ nb_conjoints }}</div>
                <div class="stat-label">Conjoints</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ nb_actifs }}</div>
                <div class="stat-label">Actifs</div>
            </div>
        </div>
    </div>
</div>

<!-- Contenu Onglet 5: Documents -->
<div class="tab-content {% if request.GET.tab == 'documents' %}active{% endif %}" id="documents">
    <div class="form-section">
        <div class="section-header">
            <h3>Documents de l'employ√©</h3>
            <button type="button" class="btn btn-primary" id="addDocumentBtn">
                <i class="fas fa-plus"></i> Ajouter un document
            </button>
        </div>
        {% if documents %}
        <table class="data-table">
            <thead>
            <tr>
                <th>Type de document</th>
                <th>Nom du document</th>
                <th>Description</th>
                <th>Date d'ajout</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for doc in documents %}
            <tr>
                <td>{{ doc.type_document }}</td>
                <td>{{ doc.fichier.name }}</td>
                <td>
                    {% if doc.description %}
                    <small>{{ doc.description|truncatewords:10 }}</small>
                    {% else %}
                    <small class="text-muted">- - - </small>
                    {% endif %}
                </td>
                <td>{{ doc.date_ajout|date:"d/m/Y H:i" }}</td>
                <td>
                    <div class="action-buttons">
                        <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-primary btn-sm">
                            <i class="fas fa-download"></i>
                        </a>
                        <button type="button" class="btn btn-danger btn-sm delete-document-btn"
                                data-id="{{ doc.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">Aucun document enregistr√©</p>
        {% endif %}
    </div>
</div>
