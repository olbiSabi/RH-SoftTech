{% load static %}
<!-- ========================================== -->
<!-- ONGLET AGENT -->
<!-- ========================================== -->
<div class="tab-pane fade show active" id="emp_agent" role="tabpanel" aria-labelledby="emp_agent-tab">
    <!-- ======= ZONE DE MESSAGES ======= -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {% if message.tags == 'success' %}
                    <i class="bi bi-check-circle-fill"></i>
                {% elif message.tags == 'error' or message.tags == 'danger' %}
                    <i class="bi bi-exclamation-triangle-fill"></i>
                {% elif message.tags == 'warning' %}
                    <i class="bi bi-exclamation-circle-fill"></i>
                {% else %}
                    <i class="bi bi-info-circle-fill"></i>
                {% endif %}
                <strong>{{ message }}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
    <!-- ======= FIN ZONE DE MESSAGES ======= -->

    <!-- EN-TÊTE AVEC PHOTO DE PROFIL -->
    {% if contrats %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="profile-header">
            <!-- Photo de profil (carrée 110x110px) -->
            <div class="profile-photo-container" onclick="openPhotoModal()">
                <img src="{{ employe.get_photo_url }}" alt="Photo de {{ employe.nom }} {{ employe.prenoms }}" class="profile-photo"
                     onerror="this.src='{% static 'assets/img/default_male_avatar.png' %}'">
                <div class="photo-overlay">
                    <i class="bi bi-camera-fill"></i>
                </div>
            </div>
            <!-- Informations de profil -->
            <div class="profile-info">
                <h1>{{ employe.nom }} {{ employe.prenoms }}</h1>
            </div>
        </div>
    </div>
    {% else %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-person-badge"></i> Nouvel agent</h1>
    </div>
    {% endif %}

    <!-- ========================================== -->
    <!-- IDENTITÉ -->
    <!-- ========================================== -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-person-vcard"></i> Informations personnelles</h4>
            {% if employe.type_dossier == 'PRE' %}
                <a href="{% url 'valider_embauche' employe.uuid %}" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Valider l'embauche
                </a>
            {% else %}
                <span class="badge bg-success">
                    <i class="bi bi-check-circle-fill"></i> Employé validé
                </span>
            {% endif %}
            <div class="pro-edit">
                {% if form.instance.matricule %}
                    <a href="{% url 'modifier_employe' employe.uuid %}" class="edit-icon">
                        <i class="fa fa-pencil"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong><i class="bi bi-upc"></i> Matricule:</strong> {{ employe.matricule }}</p>
                    <p><strong><i class="bi bi-person"></i> Nom:</strong> {{ employe.nom }}</p>
                    <p><strong><i class="bi bi-person-fill"></i> Prénom(s):</strong> {{ employe.prenoms }}</p>
                    <p><strong><i class="bi bi-calendar"></i> Date de naissance:</strong> {{ employe.date_naissance|date:"d/m/Y" }}</p>
                    <p><strong><i class="bi bi-gender-ambiguous"></i> Sexe:</strong> {{ employe.get_sexe_display }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong><i class="bi bi-heart"></i> Situation familiale:</strong> {{ employe.get_situation_familiale_display|default:"Non renseignée" }}</p>
                    <p><strong><i class="bi bi-file-text"></i> Type de dossier:</strong>
                        {% if employe.type_dossier == 'PRE' %}
                            <span class="badge bg-warning text-dark">Pré-embauche</span>
                        {% else %}
                            <span class="badge bg-success">Salarié</span>
                        {% endif %}
                    </p>
                    {% if employe.date_validation_embauche %}
                    <p><strong><i class="bi bi-check-circle"></i> Date de validation:</strong> {{ employe.date_validation_embauche|date:"d/m/Y" }}</p>
                    {% endif %}
                    <p><strong><i class="bi bi-card-text"></i> Type d'ID:</strong> {{ employe.get_type_id_display }}</p>
                    <p><strong><i class="bi bi-123"></i> Numéro ID:</strong> {{ employe.numero_id }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- CONTRATS -->
    <!-- ========================================== -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-file-earmark-text"></i> Contrats</h4>
            {% if contrats %}
            <button class="btn btn-light btn-sm" onclick="openContratModal()">
                <i class="bi bi-plus-circle"></i> Ajouter un contrat
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if contrats %}
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Date de début</th>
                        <th>Date de fin</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contrat in contrats %}
                    <tr>
                        <td>{{ contrat.get_type_contrat_display }}</td>
                        <td>{{ contrat.date_debut|date:"d/m/Y" }}</td>
                        <td>{{ contrat.date_fin|date:"d/m/Y"|default:"En cours" }}</td>
                        <td>
                            {% if not contrat.date_fin %}
                            <span class="badge bg-success">Actif</span>
                            {% else %}
                            <span class="badge bg-secondary">Clôturé</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="openContratModal({{ contrat.id }}, '{{ contrat.type_contrat }}', '{{ contrat.date_debut|date:"Y-m-d" }}', '{{ contrat.date_fin|date:"Y-m-d"|default:'' }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    onclick="confirmDeleteContrat({{ contrat.id }}, '{{ contrat.get_type_contrat_display }}', '{{ contrat.date_debut|date:"d/m/Y" }}')"
                                    title="Supprimer">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted text-center py-3">
                <i class="bi bi-inbox"></i> Aucun contrat
            </p>
            {% endif %}
        </div>
    </div>

    <!-- ========================================== -->
    <!-- AFFECTATIONS -->
    <!-- ========================================== -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-briefcase"></i> Affectations</h4>
            {% if contrats %}
            <button class="btn btn-light btn-sm" onclick="openAffectationModal()">
                <i class="bi bi-plus-circle"></i> Ajouter une affectation
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if affectations %}
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Poste</th>
                        <th>Département</th>
                        <th>Date début</th>
                        <th>Date fin</th>
                        <th>Statut</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for aff in affectations %}
                    <tr>
                        <td><strong>{{ aff.poste.CODE }}</strong><br><small class="text-muted">{{ aff.poste.LIBELLE }}</small></td>
                        <td>{{ aff.poste.DEPARTEMENT.LIBELLE }}</td>
                        <td>{{ aff.date_debut|date:"d/m/Y" }}</td>
                        <td>{{ aff.date_fin|date:"d/m/Y"|default:"En cours" }}</td>
                        <td>
                            {% if not aff.date_fin %}
                            <span class="badge bg-success badge-actif"><i class="bi bi-check-circle"></i> Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Clôturée</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning"
                                    onclick="openAffectationModal({{ aff.id }}, {{ aff.poste.id }}, '{{ aff.date_debut|date:"Y-m-d" }}', '{{ aff.date_fin|date:"Y-m-d"|default:'' }}')"
                                    title="Modifier">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    onclick="confirmDeleteAffectation({{ aff.id }}, '{{ aff.poste.LIBELLE }}')"
                                    title="Supprimer">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted text-center py-3">
                <i class="bi bi-inbox"></i> Aucune affectation enregistrée
            </p>
            {% endif %}
        </div>
    </div>

    <!-- ========================================== -->
    <!-- DOCUMENTS -->
    <!-- ========================================== -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> Documents Employés</h4>
            {% if contrats %}
                <button type="button" class="btn btn-light btn-sm" onclick="openDocumentModal()">
                    <i class="bi bi-plus-circle"></i> Joindre un document
                </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if documents %}
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Type de document</th>
                    <th>Nom du fichier</th>
                    <th>Description</th>
                    <th>Date d'ajout</th>
                    <th>Taille</th>
                    <th class="text-center">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for document in documents %}
                <tr>
                    <td><i class="bi bi-file-earmark"></i> <strong>{{ document.get_type_document_display }}</strong></td>
                    <td>{{ document.get_nom_fichier }}</td>
                    <td>
                        {% if document.description %}
                        <small>{{ document.description|truncatewords:10 }}</small>
                        {% else %}
                        <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td>{{ document.date_ajout|date:"d/m/Y H:i" }}</td>
                    <td>{{ document.get_taille_lisible }}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a href="{% url 'telecharger_document' document.id %}" class="btn btn-sm btn-success" title="Télécharger">
                                <i class="bi bi-download"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="confirmDeleteDocument({{ document.id }}, '{{ document.get_type_document_display|escapejs }}')"
                                    title="Supprimer">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted text-center py-3">
                <i class="bi bi-inbox"></i> Aucun document enregistré
            </p>
            {% endif %}
        </div>
    </div>
</div>
<!-- FIN ONGLET AGENT -->