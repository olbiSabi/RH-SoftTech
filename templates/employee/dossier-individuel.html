{% extends 'base/base.html' %}
{% load static %}

{% block extrastylet %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<!-- STYLES DES ONGLETS -->
<link rel="stylesheet" href="{% static 'assets/css/employee_tabs.css' %}">
{% endblock %}

{% block pageContent %}

<!-- CONTENEUR PRINCIPAL AVEC ANIMATION -->
<div class="page-container">
    <div class="container mt-2">
        <!-- BARRE D'ONGLETS -->
        <div class="card tab-box">
            <div class="row user-tabs">
                <div class="col-12">
                    <ul class="nav nav-tabs nav-tabs-bottom" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="emp_agent-tab" data-bs-toggle="tab" data-bs-target="#emp_agent" type="button" role="tab" aria-controls="emp_agent" aria-selected="true">
                                <i class="bi bi-person-badge"></i> Agent
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="emp_coordonnee-tab" data-bs-toggle="tab" data-bs-target="#emp_coordonnee" type="button" role="tab" aria-controls="emp_coordonnee" aria-selected="false">
                                <i class="bi bi-telephone"></i> Coordonn√©es
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="emp_famille-tab" data-bs-toggle="tab" data-bs-target="#emp_famille" type="button" role="tab" aria-controls="emp_famille" aria-selected="false">
                                <i class="bi bi-people"></i> Famille
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bank_statutory-tab" data-bs-toggle="tab" data-bs-target="#bank_statutory" type="button" role="tab" aria-controls="bank_statutory" aria-selected="false">
                                <i class="bi bi-bank"></i> Banque & Situation
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CONTENU DES ONGLETS -->
        <div class="tab-content" id="employeeTabContent">
            <!-- ONGLET 1 : AGENT -->
            {% include 'employee/onglets/agents.html' %}

            <!-- ONGLET 2 : COORDONN√âES -->
            {% include 'employee/onglets/coordonnees.html' %}

            <!-- ONGLET 3 : FAMILLE -->
            {% include 'employee/onglets/famille.html' %}

            <!-- ONGLET 4 : BANQUE & SITUATION -->
            {% include 'employee/onglets/banque_situation.html' %}
        </div>
    </div>
</div>

<!-- MODAL POUR MODIFIER LA PHOTO -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-camera"></i> Modifier la photo de profil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="photoForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="employe_uuid" value="{{ employe.uuid }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="photoFile" class="form-label">Choisir une photo <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="photoFile" name="photo" accept="image/jpeg,image/png,image/gif" required>
                        <div class="form-text">
                            Format carr√© recommand√© (1:1) - Max 5 MB<br>
                            Formats accept√©s: JPG, PNG, GIF
                        </div>
                    </div>
                    <div id="photoPreview" class="text-center d-none">
                        <img id="previewImage" src="" alt="Aper√ßu" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                    </div>
                    <div class="alert alert-danger d-none" id="photoError"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AUTRES MODALS -->
{% include 'employee/modal/modal_employee.html' %}

{% endblock %}

{% block extrascript %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'assets/js/modal.js' %}"></script>

<script>
    /**
 * ========================================
 * CONSERVATION DE L'ONGLET ACTIF
 * ========================================
 *
 * Ce script permet de :
 * 1. Sauvegarder l'onglet actif dans l'URL (#)
 * 2. Restaurer l'onglet apr√®s rechargement de la page
 * 3. Rester sur l'onglet apr√®s une action (ajout/modif/suppression)
 */

(function() {
    'use strict';

    // ========================================
    // 1. RESTAURER L'ONGLET AU CHARGEMENT
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        // R√©cup√©rer l'onglet depuis l'URL (apr√®s le #)
        let hash = window.location.hash;

        // Si pas de hash, r√©cup√©rer depuis localStorage (fallback)
        if (!hash) {
            hash = localStorage.getItem('activeTab');
        }

        if (hash) {
            // Activer l'onglet correspondant
            const tabTrigger = document.querySelector(`button[data-bs-target="${hash}"]`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();

                // Scroller vers le haut de la page
                window.scrollTo(0, 0);
            }
        }
    });

    // ========================================
    // 2. SAUVEGARDER L'ONGLET AU CLIC
    // ========================================
    document.addEventListener('shown.bs.tab', function(event) {
        // R√©cup√©rer l'ID de l'onglet activ√©
        const tabId = event.target.getAttribute('data-bs-target');

        // Sauvegarder dans l'URL
        history.pushState(null, null, tabId);

        // Sauvegarder dans localStorage (fallback)
        localStorage.setItem('activeTab', tabId);
    });

    // ========================================
    // 3. CONSERVER L'ONGLET LORS DES ACTIONS FORMULAIRE
    // ========================================

    // Intercepter tous les formulaires
    document.addEventListener('submit', function(event) {
        const form = event.target;

        // R√©cup√©rer l'onglet actif
        const activeTab = document.querySelector('.nav-link.active');
        if (activeTab) {
            const tabId = activeTab.getAttribute('data-bs-target');

            // Ajouter l'onglet comme champ cach√© dans le formulaire
            let hiddenField = form.querySelector('input[name="active_tab"]');
            if (!hiddenField) {
                hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = 'active_tab';
                form.appendChild(hiddenField);
            }
            hiddenField.value = tabId;
        }
    });

    // ========================================
    // 4. GESTION DES MODALS
    // ========================================

    // Quand on ouvre un modal, sauvegarder l'onglet actif
    document.querySelectorAll('.modal').forEach(function(modal) {
        modal.addEventListener('show.bs.modal', function() {
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-bs-target');

                // Sauvegarder dans le modal
                const form = modal.querySelector('form');
                if (form) {
                    let hiddenField = form.querySelector('input[name="active_tab"]');
                    if (!hiddenField) {
                        hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = 'active_tab';
                        form.appendChild(hiddenField);
                    }
                    hiddenField.value = tabId;
                }
            }
        });
    });

    // ========================================
    // 5. GESTION DES LIENS DE SUPPRESSION
    // ========================================

    // Ajouter l'onglet actif aux liens de suppression
    document.addEventListener('click', function(event) {
        const target = event.target.closest('a[href*="supprimer"], a[href*="delete"]');

        if (target) {
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-bs-target');
                const url = new URL(target.href, window.location.origin);
                url.searchParams.set('active_tab', tabId);
                target.href = url.toString();
            }
        }
    });

    // ========================================
    // 6. GESTION DES SUPPRESSIONS AJAX
    // ========================================

    // Pour les fonctions de confirmation de suppression
    window.getActiveTabId = function() {
        const activeTab = document.querySelector('.nav-link.active');
        return activeTab ? activeTab.getAttribute('data-bs-target') : '#emp_agent';
    };

    // ========================================
    // 7. DEBUGGING (√† supprimer en production)
    // ========================================

    // Afficher l'onglet actif dans la console
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.addEventListener('shown.bs.tab', function(event) {
            console.log('üîÑ Onglet activ√©:', event.target.getAttribute('data-bs-target'));
        });
    }

})();

</script>
{% endblock %}