{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ONIAN-SofTech{% endblock %}</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/AdminLTELogo.png' %}">
    <!-- Chargez les CSS un par un pour debug -->
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/dossier_individuel.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/dossier_individuel_base.css' %}">
</head>
<body data-employe-uuid="{% if employe %}{{ employe.uuid }}{% endif %}">
<!-- Header -->
{% include 'base/header.html' %}

<!-- Container principal -->
<div class="container-fluid">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Liste des Employ√©s ({{ employes_actifs.count }})</h2>
            <input type="text" class="search-box" placeholder="Rechercher un employ√©..." id="searchBox">
        </div>
        <ul class="employee-list" id="employeeList">
            {% for emp in employes_actifs %}
            <li class="employee-item {% if employe and emp.uuid == employe.uuid %}active{% endif %}"
                data-uuid="{{ emp.uuid }}">
                <div class="employee-matricule">{{ emp.matricule }}</div>
                <div class="employee-name">{{ emp.nom }} {{ emp.prenoms }}</div>
            </li>
            {% empty %}
            <li style="padding: 20px; text-align: center; color: #999;">
                Aucun employ√© trouv√©
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Content principal -->
    <div class="content">
        {% if not employe %}
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3>S√©lectionnez un employ√©</h3>
            <p>Cliquez sur un employ√© dans la liste pour afficher ses informations</p>
        </div>
        {% else %}
        <div class="content-header">
            <!-- Photo cliquable -->
            <div class="photo-container">
                <img src="{{ employe.get_photo_url }}"
                     alt="{{ employe.nom }}"
                     class="employee-photo photo-clickable"
                     id="employeePhoto"
                     data-employe-uuid="{{ employe.uuid }}">
                <input type="file"
                       id="photoInput"
                       accept=".jpg,.jpeg,.png,.gif"
                       style="display: none;">
            </div>
            <div class="employee-info">
                <h1 class="employee-title">{{ employe.nom }} {{ employe.prenoms }}</h1>
                <p class="employee-subtitle">
                    Matricule: {{ employe.matricule }} |
                    {% if employe.etat == 'actif' %}
                    <span class="badge badge-success">Actif</span>
                    {% else %}
                    <span class="badge badge-danger">Inactif</span>
                    {% endif %}
                </p>
            </div>
        </div>
        <!-- Onglets -->
        <div class="tabs">
            <a href="{% url 'dossier_individuel_detail' employe.uuid %}?tab=donnees"
               class="tab {% if request.GET.tab == 'donnees' or not request.GET.tab %}active{% endif %}">
                Donn√©es Agent
            </a>
            <a href="{% url 'dossier_individuel_detail' employe.uuid %}?tab=coordonnees"
               class="tab {% if request.GET.tab == 'coordonnees' %}active{% endif %}">
                Coordonn√©es
            </a>
            <a href="{% url 'dossier_individuel_detail' employe.uuid %}?tab=contrats"
               class="tab {% if request.GET.tab == 'contrats' %}active{% endif %}">
                Contrats & Affectations
            </a>
            <a href="{% url 'dossier_individuel_detail' employe.uuid %}?tab=famille"
               class="tab {% if request.GET.tab == 'famille' %}active{% endif %}">
                Famille
            </a>
            <a href="{% url 'dossier_individuel_detail' employe.uuid %}?tab=documents"
               class="tab {% if request.GET.tab == 'documents' %}active{% endif %}">
                Documents
            </a>
        </div>

        {% include 'employee/onglets/onglet_dossier_individuel.html' %}

        {% endif %}
    </div>
</div>

<!-- MODALES -->
{% if employe %}

{% include 'employee/modal/modal_dossier_individuel.html' %}

{% endif %}

<script src="{% static 'assets/js/dossier_individuel.js' %}"></script>
<script>
    // Gestion du changement de photo
    document.addEventListener('DOMContentLoaded', function() {
        const photoElement = document.getElementById('employeePhoto');
        const photoInput = document.getElementById('photoInput');
        const photoOverlay = document.querySelector('.photo-overlay');

        if (photoElement && photoInput) {
            // Rendre la photo et l'overlay cliquables
            photoElement.addEventListener('click', () => photoInput.click());
            if (photoOverlay) {
                photoOverlay.addEventListener('click', () => photoInput.click());
            }

            // G√©rer le changement de fichier
            photoInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validation
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (!['.jpg', '.jpeg', '.png', '.gif'].includes(ext)) {
                    showAlert('Format non autoris√©. Formats accept√©s: JPG, JPEG, PNG, GIF', 'danger');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showAlert('La taille de la photo ne doit pas d√©passer 5 MB', 'danger');
                    return;
                }

                // Aper√ßu imm√©diat
                const reader = new FileReader();
                reader.onload = (e) => photoElement.src = e.target.result;
                reader.readAsDataURL(file);

                // Envoyer au serveur
                await uploadPhoto(file, photoElement);
            });
        }
    });

    async function uploadPhoto(file, photoElement) {
        const formData = new FormData();
        formData.append('employe_uuid', photoElement.dataset.employeUuid);
        formData.append('photo', file);

        showLoading();
        try {
            const response = await fetch('/employe/ajax/photo/modifier/', {
                method: 'POST',
                headers: {'X-CSRFToken': csrftoken},
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showAlert('‚úÖ Photo mise √† jour avec succ√®s', 'success');
                if (data.photo_url) {
                    photoElement.src = data.photo_url + '?t=' + new Date().getTime();
                }
            } else {
                showAlert('‚ùå ' + (data.error || 'Erreur inconnue'), 'danger');
            }
        } catch (error) {
            showAlert('‚ùå Erreur lors du t√©l√©chargement', 'danger');
        } finally {
            hideLoading();
            document.getElementById('photoInput').value = '';
        }
    }
</script>
</body>
</html>