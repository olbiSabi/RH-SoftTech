{% extends 'base/baseSansMatricule.html' %}
{% load static %}

{% block extrastylet %}
<style>
    .form-card {
        border-left: 4px solid #1c5d5f;
    }
    .section-header {
        background: linear-gradient(135deg, #1c5d5f 0%, #193f41 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 5px 5px 0 0;
    }
    .btn-submit {
        background-color: #1c5d5f;
        border-color: #1c5d5f;
        color: white;
    }
    .btn-submit:hover {
        background-color: #164849;
        border-color: #164849;
        color: white;
    }
    .severity-info { border-left: 4px solid #17a2b8; }
    .severity-warning { border-left: 4px solid #ffc107; }
    .severity-critical { border-left: 4px solid #dc3545; }
    .code-display {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
        font-family: monospace;
        font-weight: 600;
        color: #495057;
    }
    .code-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 0.25rem;
        padding: 10px 15px;
        color: #0c5460;
    }
</style>
{% endblock %}

{% block pageContent %}
<section class="content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-cogs"></i>
                        {% if regle %}Modifier la règle{% else %}Nouvelle règle de conformité{% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'audit:dashboard' %}">Audit</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'audit:liste_regles' %}">Règles</a></li>
                        <li class="breadcrumb-item active">{% if regle %}Modifier{% else %}Nouvelle{% endif %}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8">
                <form method="post">
                    {% csrf_token %}

                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Veuillez corriger les erreurs ci-dessous.
                        <ul class="mb-0 mt-2">
                            {% for field in form %}
                                {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Informations générales -->
                    <div class="card form-card mb-3">
                        <div class="section-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informations générales</h5>
                        </div>
                        <div class="card-body">
                            {% if regle %}
                            <!-- Affichage du code existant en modification -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label>Code</label>
                                    <div class="code-display">{{ regle.CODE }}</div>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="id_LIBELLE">Libellé <span class="text-danger">*</span></label>
                                    {{ form.LIBELLE }}
                                </div>
                            </div>
                            {% else %}
                            <!-- Message pour la création -->
                            <div class="code-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>Code automatique :</strong> Le code de la règle sera généré automatiquement en fonction du type sélectionné.
                                <br><small>Format : TYPE-XXXX (ex: CONT-0001, DOC-0002, FORM-0003)</small>
                            </div>
                            <div class="mb-3">
                                <label for="id_LIBELLE">Libellé <span class="text-danger">*</span></label>
                                {{ form.LIBELLE }}
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label for="id_DESCRIPTION">Description</label>
                                {{ form.DESCRIPTION }}
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="id_TYPE_REGLE">Type de règle <span class="text-danger">*</span></label>
                                    {{ form.TYPE_REGLE }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="id_SEVERITE">Sévérité <span class="text-danger">*</span></label>
                                    {{ form.SEVERITE }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="id_FREQUENCE_VERIFICATION">Fréquence <span class="text-danger">*</span></label>
                                    {{ form.FREQUENCE_VERIFICATION }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paramètres -->
                    <div class="card form-card mb-3">
                        <div class="section-header">
                            <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Paramètres</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_JOURS_AVANT_EXPIRATION">Jours avant expiration</label>
                                    {{ form.JOURS_AVANT_EXPIRATION }}
                                    <small class="form-text text-muted">
                                        Nombre de jours avant l'expiration pour déclencher l'alerte.
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_STATUT">Statut</label>
                                    <div class="custom-control custom-switch mt-2">
                                        {{ form.STATUT }}
                                        <label class="custom-control-label" for="id_STATUT">Règle active</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="card form-card mb-3">
                        <div class="section-header">
                            <h5 class="mb-0"><i class="fas fa-bell"></i> Notifications</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        {{ form.NOTIFIER_EMPLOYE }}
                                        <label class="custom-control-label" for="id_NOTIFIER_EMPLOYE">
                                            Notifier l'employé concerné
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        {{ form.NOTIFIER_MANAGER }}
                                        <label class="custom-control-label" for="id_NOTIFIER_MANAGER">
                                            Notifier le manager
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        {{ form.NOTIFIER_RH }}
                                        <label class="custom-control-label" for="id_NOTIFIER_RH">
                                            Notifier les RH
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="id_EMAILS_SUPPLEMENTAIRES">Emails supplémentaires</label>
                                {{ form.EMAILS_SUPPLEMENTAIRES }}
                                <small class="form-text text-muted">
                                    Un email par ligne. Ces adresses recevront également les notifications.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-between mb-4">
                        <a href="{% url 'audit:liste_regles' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-submit">
                            <i class="fas fa-save"></i>
                            {% if regle %}Enregistrer les modifications{% else %}Créer la règle{% endif %}
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <!-- Aide sur les types -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle text-info"></i> Types de règles</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Contrat (CONT) :</strong><br>
                        <small class="text-muted">Vérifie les dates d'expiration des contrats de travail.</small></p>

                        <p class="mb-2"><strong>Document (DOC) :</strong><br>
                        <small class="text-muted">Vérifie la validité des documents (CNI, permis, etc.).</small></p>

                        <p class="mb-2"><strong>Formation (FORM) :</strong><br>
                        <small class="text-muted">Vérifie les formations obligatoires et leurs échéances.</small></p>

                        <p class="mb-2"><strong>Visite médicale (VMED) :</strong><br>
                        <small class="text-muted">Vérifie les dates des visites médicales obligatoires.</small></p>

                        <p class="mb-2"><strong>Congé (CONG) :</strong><br>
                        <small class="text-muted">Vérifie les soldes de congés et les anomalies.</small></p>

                        <p class="mb-0"><strong>Matériel (MAT) :</strong><br>
                        <small class="text-muted">Vérifie les affectations et maintenances du matériel.</small></p>
                    </div>
                </div>

                <!-- Aide sur les sévérités -->
                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-exclamation-circle text-warning"></i> Niveaux de sévérité</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info py-2 severity-info">
                            <strong>Information</strong><br>
                            <small>Alerte informative, pas d'action urgente requise.</small>
                        </div>
                        <div class="alert alert-warning py-2 severity-warning">
                            <strong>Avertissement</strong><br>
                            <small>Attention requise, action à planifier.</small>
                        </div>
                        <div class="alert alert-danger py-2 severity-critical">
                            <strong>Critique</strong><br>
                            <small>Action immédiate requise, non-conformité majeure.</small>
                        </div>
                    </div>
                </div>

                {% if regle %}
                <!-- Statistiques de la règle -->
                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Statistiques</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <strong>Code :</strong>
                            <span class="badge badge-primary">{{ regle.CODE }}</span>
                        </p>
                        <p class="mb-2">
                            <strong>Alertes générées :</strong>
                            <span class="badge badge-secondary">{{ regle.alertes.count }}</span>
                        </p>
                        <p class="mb-2">
                            <strong>Créée le :</strong><br>
                            <small class="text-muted">{{ regle.CREATED_AT|date:"d/m/Y H:i" }}</small>
                        </p>
                        <p class="mb-0">
                            <strong>Dernière modification :</strong><br>
                            <small class="text-muted">{{ regle.UPDATED_AT|date:"d/m/Y H:i" }}</small>
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extrascript %}
<script>
$(document).ready(function() {
    // Ajouter les classes Bootstrap aux champs du formulaire
    $('#id_LIBELLE, #id_JOURS_AVANT_EXPIRATION').addClass('form-control');
    $('#id_DESCRIPTION, #id_EMAILS_SUPPLEMENTAIRES').addClass('form-control');
    $('#id_TYPE_REGLE, #id_SEVERITE, #id_FREQUENCE_VERIFICATION').addClass('form-control');

    // Checkboxes
    $('#id_NOTIFIER_EMPLOYE, #id_NOTIFIER_MANAGER, #id_NOTIFIER_RH').addClass('custom-control-input');
    $('#id_STATUT').addClass('custom-control-input');
});
</script>
{% endblock %}
