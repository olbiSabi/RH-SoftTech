{% load static %}
<!-- Header -->
<header class="header">
    <div class="header-content">
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo-left">
                <a href="{% url 'dashboard' %}" class="logo">
                    <img src="{% static 'assets/img/logo/Onian-EasyM.png' %}" width="50" height="50" alt="">
                </a>
            </div>
            <div class="page-title-box">
                <h3>EasyM</h3>
            </div>
            <!-- Menu Horizontal -->
            <nav class="horizontal-menu">
                <ul class="menu-list">

                    <!-- ========================================
                         MENU SALARIÉS
                         Visible pour : DRH, GESTION_APP, ASSISTANT_RH
                         ======================================== -->
                    {% if user.is_authenticated and user.employe %}
                        {% if user.employe.peut_gerer_employes or user.is_superuser or user.is_staff %}
                        <li class="menu-item">
                            <a href="#" class="menu-link">
                                <i class="fas fa-users"></i>
                                <span>Salariés</span>
                                <i class="fas fa-chevron-down menu-arrow"></i>
                            </a>
                            <ul class="submenu">
                                <!-- Embaucher agent : DRH/GESTION_APP/Admin uniquement -->
                                {% if user.employe.peut_embaucher or user.is_superuser or user.is_staff %}
                                <li>
                                    <a href="{% url 'employee:embauche_agent' %}">
                                        <i class="fas fa-file-contract"></i>Embaucher agent
                                    </a>
                                </li>
                                {% endif %}

                                <!-- Liste agents : DRH/GESTION_APP/Admin uniquement -->
                                {% if user.employe.peut_embaucher or user.is_superuser or user.is_staff %}
                                <li>
                                    <a href="{% url 'employee:liste_employes' %}">
                                        <i class="fas fa-clipboard-check"></i>Liste agents
                                    </a>
                                </li>
                                {% endif %}

                                <!-- Dossier individuel : Tous les rôles RH (y compris Assistant RH) -->
                                <li>
                                    <a href="{% url 'employee:dossier_individuel' %}">
                                        <i class="fas fa-check-circle"></i>Dossier individuel
                                    </a>
                                </li>
                            </ul>
                        </li>
                        {% endif %}
                    {% endif %}

                    <!-- ========================================
                        MENU ABSENCE
                        Visible pour : Tout le monde
                    ======================================== -->
                    <li class="menu-item">
                        <a href="#" class="menu-link">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Absence</span>
                            <i class="fas fa-chevron-down menu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <!-- Acquisition congé : DRH, GESTION_APP uniquement -->
                            {% if user.is_authenticated and user.employe %}
                                {% if user.employe.peut_embaucher or user.employe.peut_gerer_parametrage_app or user.is_superuser %}
                                <li>
                                    <a href="{% url 'absence:liste_acquisitions' %}">
                                        <i class="fas fa-calendar-check"></i>Acquisition congé
                                    </a>
                                </li>
                                {% endif %}
                            {% endif %}

                            <!-- Demande d'absence : Visible pour tout le monde -->
                            <li>
                                <a href="{% url 'absence:liste_absences' %}">
                                    <i class="fas fa-calendar-plus"></i>Demande d'absence
                                </a>
                            </li>

                            <!-- Validation manager : MANAGER_ABS + Managers de département -->
                            {% if user.employe.est_manager_departement %}
                            <li>
                                <a href="{% url 'absence:validation_manager' %}">
                                    <i class="fas fa-user-check"></i>Validation manager
                                </a>
                            </li>
                            {% endif %}

                            <!-- Validation RH : RH_VALIDATION_ABS, DRH, GESTION_APP -->
                            {% if user.employe.peut_valider_absence_rh %}
                            <li>
                                <a href="{% url 'absence:validation_rh' %}">
                                    <i class="fas fa-user-shield"></i>Validation RH
                                </a>
                            </li>
                            {% endif %}

                            <!-- Consultation absences : ASSISTANT_RH, RH_VALIDATION_ABS, DRH, GESTION_APP -->
                            {% if user.employe.est_assistant_rh or user.employe.peut_valider_absence_rh or user.employe.peut_gerer_parametrage_app %}
                            <li>
                                <a href="{% url 'absence:consultation_absences' %}">
                                    <i class="fas fa-eye"></i>Consulter absences
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>

                    <!-- ========================================
                         MENU RAPPORTS
                         Visible pour : Tout le monde
                         ======================================== -->
                    <li class="menu-item">
                        <a href="#" class="menu-link">
                            <i class="fas fa-chart-bar"></i>
                            <span>Rapports</span>
                            <i class="fas fa-chevron-down menu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li><a href="#"><i class="fas fa-file-alt"></i> Rapport mensuel</a></li>
                            <li><a href="#"><i class="fas fa-chart-pie"></i> Statistiques</a></li>
                            <li><a href="#"><i class="fas fa-calendar-alt"></i> Rapport annuel</a></li>
                        </ul>
                    </li>
                    <!-- ========================================
                       MENU PARAMÈTRES
                       Visible UNIQUEMENT pour : DRH, GESTION_APP, Admin
                    ======================================== -->
                    {% if user.is_authenticated and user.employe %}
                    {% if user.employe.peut_embaucher or user.employe.peut_gerer_parametrage_app or user.is_superuser or user.employe.est_assistant_rh%}
                    <li class="menu-item">
                        <a href="#" class="menu-link">
                            <i class="fas fa-cog"></i>
                            <span>Paramètres</span>
                            <i class="fas fa-chevron-down menu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <!-- Département : DRH, GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'departement:list' %}">
                                    <i class="fas fa-briefcase"></i>Département
                                </a>
                            </li>

                            <!-- Poste : DRH, GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'departement:poste_list' %}">
                                    <i class="fas fa-id-card"></i>Poste
                                </a>
                            </li>
                            <!-- Managers : DRH, GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'departement:liste_managers' %}">
                                    <i class="fas fa-user-tie"></i>Managers
                                </a>
                            </li>

                            <!-- ====== SECTION RÉSERVÉE GESTION_APP ====== -->
                            {% if user.employe.peut_gerer_parametrage_app or user.is_superuser %}

                            <!-- Entreprise : GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'entreprise:profil_entreprise' %}">
                                    <i class="fas fa-building"></i>Entreprise
                                </a>
                            </li>
                            <!-- Gestion de rôles : GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'employee:gestion_roles' %}">
                                    <i class="fas fa-user-shield"></i>Gestion de rôles
                                </a>
                            </li>
                            <!-- Type d'absence : GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'absence:liste_types_absence' %}">
                                    <i class="fas fa-calendar-times"></i>Type d'absence
                                </a>
                            </li>

                            <!-- Conventions : GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'absence:liste_conventions' %}">
                                    <i class="fas fa-umbrella-beach"></i>Conventions
                                </a>
                            </li>
                            <!-- Jours fériés : GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'absence:liste_jours_feries' %}">
                                    <i class="fas fa-calendar-day"></i>Jours fériés
                                </a>
                            </li>
                            <!-- Paramètres calculs : GESTION_APP uniquement -->
                            <li>
                                <a href="{% url 'absence:liste_parametres_calcul' %}">
                                    <i class="fas fa-calculator"></i>Paramètres calculs
                                </a>
                            </li>

                            {% endif %}
                        </ul>
                    </li>
                    {% endif %} {% endif %}
                </ul>
            </nav>
        </div>
        <div class="header-right">
            <!-- ✅ NOTIFICATIONS -->
            {% if user.is_authenticated %}
            <div class="notifications-dropdown">
                <button class="notifications-btn" id="notificationsBtn">
                    <i class="fas fa-bell"></i>
                    {% if notifications_absences_count > 0 %}
                    <span class="notifications-badge">{{ notifications_absences_count }}</span>
                    {% endif %}
                </button>

                <div class="notifications-menu" id="notificationsMenu">
                    <div class="notifications-header">
                        <h4>Notifications</h4>
                        {% if notifications_absences_count > 0 %}
                        <a href="{% url 'absence:marquer_toutes_lues' %}" class="mark-all-read">
                            Tout marquer comme lu
                        </a>
                        {% endif %}
                    </div>

                    <div class="notifications-list">
                        {% if notifications_absences %}
                        {% for notif in notifications_absences %}
                        <a href="{% url 'absence:notification_detail' notif.id %}"
                           class="notification-item {% if not notif.lue %}unread{% endif %}">
                            <div class="notification-icon">
                                {% if notif.contexte == 'MANAGER' %}
                                <i class="fas fa-user-tie text-primary"></i>
                                {% elif notif.contexte == 'RH' %}
                                <i class="fas fa-user-shield text-success"></i>
                                {% else %}
                                {% if notif.type_notification == 'DEMANDE_CREEE' %}
                                <i class="fas fa-plus-circle text-info"></i>
                                {% elif notif.type_notification == 'DEMANDE_VALIDEE_MANAGER' %}
                                <i class="fas fa-user-check text-info"></i>
                                {% elif notif.type_notification == 'VALIDATION_MANAGER' %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% elif notif.type_notification == 'VALIDATION_RH' %}
                                <i class="fas fa-check-double text-success"></i>
                                {% elif 'REJET' in notif.type_notification %}
                                <i class="fas fa-times-circle text-danger"></i>
                                {% elif notif.type_notification == 'ABSENCE_ANNULEE' %}
                                <i class="fas fa-ban text-warning"></i>
                                {% endif %}
                                {% endif %}
                            </div>
                            <div class="notification-content">
                                <div class="notification-message">
                                    {% if notif.contexte %}
                                    <span class="context-badge context-{{ notif.contexte|lower }}">
                                        {{ notif.get_contexte_display }}
                                    </span>
                                    {% endif %}
                                    {{ notif.message }}
                                </div>
                                <div class="notification-time">
                                    {{ notif.date_creation|timesince }}
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                        {% else %}
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>Aucune notification</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="notifications-footer">
                        <a href="{% url 'absence:toutes_notifications' %}" class="notification-see-all">
                            <i class="fas fa-history"></i> Voir toutes les notifications
                            {% if notifications_absences_count > 5 %}
                            ({{ notifications_absences_count }})
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- User Info -->
            <div class="user-info">
                {% if user.is_authenticated %}
                <ul class="menu-list">
                    <li class="menu-item">
                        <a href="#" class="menu-link">
                            {% if user.employe %}
                            <img src="{{ user.employe.get_photo_url }}"
                                 alt="{{ user.employe.username }}"
                                 class="user-avatar"
                                 style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
                            {% else %}
                            <i class="fas fa-user-circle"></i>
                            {% endif %}
                            <span>
                                {% if user.employe %}
                                    {{ user.employe.username }} {{ user.employe.prenomuser }}
                                {% else %}
                                    {{ user.get_full_name|default:user.username }}
                                {% endif %}
                            </span>
                            <i class="fas fa-chevron-down menu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="{% url 'employee:profil' request.user.employe.matricule %}">
                                    <i class="fas fa-user-circle"></i> Mon Profil
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'change_password' %}">
                                    <i class="fas fa-key"></i> Changer mot de passe
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'logout' %}">
                                    <i class="fas fa-power-off"></i> Déconnexion
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                {% else %}
                <a href="{% url 'login' %}" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Connexion
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</header>

<!-- Overlay pour fermer le sidebar sur mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>