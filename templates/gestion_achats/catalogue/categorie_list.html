{% extends 'base/baseSansMatricule.html' %}
{% load static %}
{% load gac_permissions %}

{% block extrastylet %}
<link rel="stylesheet" href="{% static 'gestion_achats/css/gac_styles.css' %}">
<style>
    /* Style pour l'arborescence des catégories */
    .categorie-tree {
        list-style: none;
        padding-left: 20px;
        margin: 0;
    }
    .categorie-tree li {
        margin-bottom: 5px;
        border-left: 2px solid #dee2e6;
        padding-left: 15px;
    }
    .categorie-tree li.root-category {
        border-left: none;
        padding-left: 0;
    }
    .categorie-item {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 5px;
    }
    .categorie-item:hover {
        background: #e9ecef;
    }
    
    /* Surcharge de la couleur des en-têtes de tableau pour cette page */
    .table thead.bg-light th {
        color: #212529 !important;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block pageContent %}
<div class="container-fluid py-4">
    <!-- Token CSRF caché pour JavaScript -->
    {% csrf_token %}
    
    <!-- Breadcrumb -->
    {% if breadcrumb_items %}
    {% include 'gestion_achats/includes/breadcrumb.html' with breadcrumb_items=breadcrumb_items %}
    {% endif %}

    <!-- Messages -->
    {% include 'gestion_achats/includes/messages.html' %}

    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-tags me-2"></i>
            Catégories d'articles
        </h2>
        <div>
            <a href="{% url 'gestion_achats:article_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour au catalogue
            </a>
            {% is_admin_gac user as is_admin %}
            {% if is_admin %}
            <a href="{% url 'gestion_achats:categorie_create' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>Nouvelle catégorie
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-4">
            {% include 'gestion_achats/includes/stats_card.html' with title="Total catégories" value=stats.total_categories icon="tags" color="primary" %}
        </div>
        <div class="col-md-4">
            {% include 'gestion_achats/includes/stats_card.html' with title="Catégories principales" value=categories_principales|length icon="folder" color="info" %}
        </div>
        <div class="col-md-4">
            {% include 'gestion_achats/includes/stats_card.html' with title="Total articles" value=stats.total_articles icon="box" color="success" %}
        </div>
    </div>

    <div class="row">
        <!-- Vue arborescente -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-light text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-sitemap me-2"></i>
                        Arborescence des catégories
                    </h5>
                </div>
                <div class="card-body">
                    {% if categories_principales %}
                    <ul class="categorie-tree">
                        {% for categorie in categories_principales %}
                        {% include 'gestion_achats/includes/categorie_tree_item.html' %}
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        <em>Aucune catégorie créée</em>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Liste plate -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-light text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Liste complète
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="bg-light text-dark">
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Chemin complet</th>
                                    <th class="text-center">Articles</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for categorie in toutes_categories %}
                                <tr>
                                    <td><strong>{{ categorie.nom }}</strong></td>
                                    <td>
                                        {{ categorie.get_chemin_complet }}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ categorie.articles.count }}</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            {% if is_admin %}
                                            <a href="{% url 'gestion_achats:categorie_update' categorie.uuid %}"
                                               class="btn btn-sm btn-warning"
                                               title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if categorie.articles.count == 0 and categorie.sous_categories.count == 0 %}
                                            <button type="button"
                                                    class="btn btn-sm btn-danger"
                                                    onclick="confirmerSuppression('{{ categorie.uuid }}', '{{ categorie.nom|escapejs }}')"
                                                    title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">
                                        <em>Aucune catégorie</em>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale de confirmation de suppression -->
<div class="modal fade" id="suppressionModal" tabindex="-1" role="dialog" aria-labelledby="suppressionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suppressionModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmation de suppression
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Êtes-vous sûr de vouloir supprimer la catégorie <strong id="nomCategorieASupprimer"></strong> ?</p>
                <p class="text-muted small mb-0">Cette action est irréversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmSuppressionBtn">
                    <i class="fas fa-trash me-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrascript %}
<script src="{% static 'gestion_achats/js/gac_common.js' %}"></script>
<script>
    let categorieASupprimer = null;

    function confirmerSuppression(uuid, nom) {
        categorieASupprimer = uuid;
        
        // Afficher le nom de la catégorie dans la modale
        document.getElementById('nomCategorieASupprimer').textContent = nom;
        
        // Afficher la modale (Bootstrap 4)
        $('#suppressionModal').modal('show');
    }

    // Gérer la confirmation
    $(document).ready(function() {
        $('#confirmSuppressionBtn').click(function() {
            if (categorieASupprimer) {
                console.log('Tentative de suppression de:', categorieASupprimer);
                
                // Soumettre le formulaire de suppression
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/gac/catalogue/categories/${categorieASupprimer}/delete/`;

                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                console.log('CSRF Token trouvé:', csrfToken ? 'oui' : 'non');
                
                if (!csrfToken) {
                    console.error('Token CSRF non trouvé!');
                    alert('Erreur de sécurité: token CSRF non trouvé');
                    return;
                }
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;

                form.appendChild(csrfInput);
                document.body.appendChild(form);
                
                console.log('Formulaire soumis vers:', form.action);
                form.submit();
            }
        });
    });
</script>
{% endblock %}
