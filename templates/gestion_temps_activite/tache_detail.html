<!-- gestion_temps_activite/templates/gestion_temps_activite/tache_detail.html -->

{% extends 'base/baseSansMatricule.html' %}
{% load static %}

{% block extrastylet %}
<link rel="stylesheet" href="{% static 'assets/css/gta/gestion_tache.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/gta/gestion_commentaires.css' %}">
{% endblock %}

{% block pageContent %}
<section class="content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h1 class="h3 mb-2 text-gray-800">
                    <i class="fas fa-tasks"></i> {{ tache.titre }}
                </h1>
            </div>
            <div class="col-md-6 text-right">
                <a href="{% url 'gestion_temps_activite:imputation_create' %}?tache={{ tache.pk }}"
                   class="btn btn-success">
                    <i class="fas fa-clock"></i> Imputer du Temps
                </a>
                <a href="{% url 'gestion_temps_activite:document_upload' %}?type=TACHE&tache={{ tache.pk }}"
                   class="btn btn-info">
                    <i class="fas fa-paperclip"></i> Document
                </a>
                <a href="{% url 'gestion_temps_activite:tache_update' pk=tache.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <a href="{% url 'gestion_temps_activite:tache_delete' pk=tache.pk %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Supprimer
                </a>
                <a href="{% url 'gestion_temps_activite:projet_detail' pk=tache.projet.pk %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour au Projet
                </a>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Cartes de statistiques -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Avancement
                                </div>
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ tache.avancement }}%
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="progress progress-sm mr-2">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                 style="width: {{ tache.avancement }}%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Estimation
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {% if tache.estimation_heures %}
                                    {{ tache.estimation_heures }}h
                                    {% else %}
                                    Non défini
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-hourglass-start fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Temps Réalisé
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ heures_totales|floatformat:2 }}h
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-{% if ecart_estimation > 0 %}danger{% elif ecart_estimation < 0 %}success{% else %}warning{% endif %} shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-{% if ecart_estimation > 0 %}danger{% elif ecart_estimation < 0 %}success{% else %}warning{% endif %} text-uppercase mb-1">
                                    Écart
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {% if ecart_estimation != None %}
                                    {% if ecart_estimation > 0 %}+{% endif %}{{ ecart_estimation|floatformat:1 }}h
                                    {% else %}
                                    -
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-{% if ecart_estimation > 0 %}exclamation-triangle{% elif ecart_estimation < 0 %}check-circle{% else %}equals{% endif %} fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Informations de la tâche -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Informations Générales</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                            <tr>
                                <th width="40%">Code Tâche</th>
                                <td><strong>{{ tache.code_tache }}</strong></td>
                            </tr>
                            <tr>
                                <th>Titre</th>
                                <td>{{ tache.titre }}</td>
                            </tr>
                            <tr>
                                <th>Projet</th>
                                <td>
                                    <a href="{% url 'gestion_temps_activite:projet_detail' pk=tache.projet.pk %}">
                                        {{ tache.projet.nom_projet }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>Assigné à</th>
                                <td>
                                    {% if tache.assignee %}
                                    {{ tache.assignee.nom }} {{ tache.assignee.prenoms }}
                                    {% else %}
                                    <span class="text-muted">Non assigné</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Statut</th>
                                <td>
                                    {% if tache.statut == 'TERMINE' %}
                                    <span class="badge badge-success">Terminé</span>
                                    {% elif tache.statut == 'EN_COURS' %}
                                    <span class="badge badge-info">En cours</span>
                                    {% elif tache.statut == 'EN_ATTENTE' %}
                                    <span class="badge badge-warning">En attente</span>
                                    {% elif tache.statut == 'ANNULE' %}
                                    <span class="badge badge-danger">Annulé</span>
                                    {% else %}
                                    <span class="badge badge-secondary">À faire</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Priorité</th>
                                <td>
                                    {% if tache.priorite == 'CRITIQUE' %}
                                    <span class="badge badge-danger">Critique</span>
                                    {% elif tache.priorite == 'HAUTE' %}
                                    <span class="badge badge-warning">Haute</span>
                                    {% elif tache.priorite == 'NORMALE' %}
                                    <span class="badge badge-info">Normale</span>
                                    {% else %}
                                    <span class="badge badge-secondary">Basse</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if tache.tache_parente %}
                            <tr>
                                <th>Tâche Parente</th>
                                <td>
                                    <a href="{% url 'gestion_temps_activite:tache_detail' pk=tache.tache_parente.pk %}">
                                        {{ tache.tache_parente.titre }}
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                            <tr>
                                <th>Date de création</th>
                                <td>{{ tache.date_creation|date:"d/m/Y à H:i" }}</td>
                            </tr>
                            {% if tache.cree_par %}
                            <tr>
                                <th>Créée par</th>
                                <td>{{ tache.cree_par.nom }} {{ tache.cree_par.prenoms }}</td>
                            </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Planification -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Planification</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                            <tr>
                                <th width="40%">Date début prévue</th>
                                <td>
                                    {% if tache.date_debut_prevue %}
                                    {{ tache.date_debut_prevue|date:"d/m/Y" }}
                                    {% else %}
                                    <span class="text-muted">Non définie</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Date fin prévue</th>
                                <td>
                                    {% if tache.date_fin_prevue %}
                                    {{ tache.date_fin_prevue|date:"d/m/Y" }}
                                    {% else %}
                                    <span class="text-muted">Non définie</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Date début réelle</th>
                                <td>
                                    {% if tache.date_debut_reelle %}
                                    {{ tache.date_debut_reelle|date:"d/m/Y" }}
                                    {% else %}
                                    <span class="text-muted">Non commencée</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Date fin réelle</th>
                                <td>
                                    {% if tache.date_fin_reelle %}
                                    {{ tache.date_fin_reelle|date:"d/m/Y" }}
                                    {% else %}
                                    <span class="text-muted">Non terminée</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Estimation</th>
                                <td>
                                    {% if tache.estimation_heures %}
                                    <strong>{{ tache.estimation_heures }} heures</strong>
                                    {% else %}
                                    <span class="text-muted">Non définie</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Temps réalisé</th>
                                <td>
                                    <strong>{{ heures_totales|floatformat:2 }} heures</strong>
                                    {% if ecart_estimation != None %}
                                    <br>
                                    <small class="{% if ecart_estimation > 0 %}text-danger{% elif ecart_estimation < 0 %}text-success{% else %}text-muted{% endif %}">
                                        Écart: {% if ecart_estimation > 0 %}+{% endif %}{{ ecart_estimation|floatformat:1 }}h
                                        {% if tache.estimation_heures %}
                                        ({% widthratio heures_totales tache.estimation_heures 100 %}% de l'estimation)
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Avancement</th>
                                <td>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar {% if tache.avancement == 100 %}bg-success{% elif tache.avancement >= 50 %}bg-info{% else %}bg-warning{% endif %}"
                                             role="progressbar"
                                             style="width: {{ tache.avancement }}%">
                                            {{ tache.avancement }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        {% if tache.description %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Description</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">{{ tache.description|linebreaks }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sous-tâches -->
        {% if sous_taches %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Sous-tâches ({{ sous_taches.count }})</h6>
                        <a href="{% url 'gestion_temps_activite:tache_create' %}?projet={{ tache.projet.pk }}&parente={{ tache.pk }}"
                           class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Ajouter une Sous-tâche
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% for sous_tache in sous_taches %}
                            <a href="{% url 'gestion_temps_activite:tache_detail' pk=sous_tache.pk %}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ sous_tache.titre }}</h6>
                                    <small>
                                        {% if sous_tache.statut == 'TERMINE' %}
                                        <span class="badge badge-success">Terminé</span>
                                        {% elif sous_tache.statut == 'EN_COURS' %}
                                        <span class="badge badge-info">En cours</span>
                                        {% else %}
                                        <span class="badge badge-secondary">{{ sous_tache.get_statut_display }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="progress mt-2" style="height: 10px;">
                                    <div class="progress-bar" style="width: {{ sous_tache.avancement }}%"></div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Imputations de temps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Imputations de Temps</h6>
                        <a href="{% url 'gestion_temps_activite:imputation_create' %}?tache={{ tache.pk }}"
                           class="btn btn-sm btn-success">
                            <i class="fas fa-clock"></i> Imputer du Temps
                        </a>
                    </div>
                    <div class="card-body">
                        {% if imputations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Employé</th>
                                    <th>Activité</th>
                                    <th>Durée</th>
                                    <th>Commentaire</th>
                                    <th>Validé</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for imputation in imputations %}
                                <tr>
                                    <td>{{ imputation.date|date:"d/m/Y" }}</td>
                                    <td>{{ imputation.employe.nom }} {{ imputation.employe.prenoms }}</td>
                                    <td>
                                            <span class="badge badge-{% if imputation.activite.facturable %}success{% else %}secondary{% endif %}">
                                                {{ imputation.activite.libelle }}
                                            </span>
                                    </td>
                                    <td><strong>{{ imputation.duree }}h</strong></td>
                                    <td>
                                        {% if imputation.commentaire %}
                                        <small>{{ imputation.commentaire|truncatewords:10 }}</small>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if imputation.valide %}
                                        <span class="badge badge-success">
                                                <i class="fas fa-check"></i> Validé
                                            </span>
                                        {% else %}
                                        <span class="badge badge-warning">
                                                <i class="fas fa-clock"></i> En attente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'gestion_temps_activite:imputation_update' pk=imputation.pk %}"
                                           class="btn btn-sm btn-warning" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot>
                                <tr class="table-info">
                                    <td colspan="3" class="text-right"><strong>Total :</strong></td>
                                    <td><strong>{{ heures_totales|floatformat:2 }}h</strong></td>
                                    <td colspan="3"></td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clock fa-3x mb-3"></i>
                            <p>Aucune imputation de temps pour cette tâche</p>
                            <a href="{% url 'gestion_temps_activite:imputation_create' %}?tache={{ tache.pk }}"
                               class="btn btn-success">
                                <i class="fas fa-clock"></i> Imputer du Temps
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Documents</h6>
                        <a href="{% url 'gestion_temps_activite:document_upload' %}?type=TACHE&tache={{ tache.pk }}"
                           class="btn btn-sm btn-info">
                            <i class="fas fa-paperclip"></i> Ajouter un Document
                        </a>
                    </div>
                    <div class="card-body">
                        {% if documents %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>Catégorie</th>
                                    <th>Type</th>
                                    <th>Taille</th>
                                    <th>Uploadé par</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for document in documents %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-{% if document.type_fichier == 'pdf' %}pdf text-danger{% elif document.type_fichier in 'doc,docx' %}word text-primary{% elif document.type_fichier in 'xls,xlsx' %}excel text-success{% else %}alt{% endif %}"></i>
                                        {{ document.nom_document }}
                                    </td>
                                    <td>{{ document.get_categorie_display }}</td>
                                    <td><span class="badge badge-secondary">{{ document.type_fichier|upper }}</span>
                                    </td>
                                    <td>{{ document.get_taille_formatee }}</td>
                                    <td>
                                        {% if document.uploade_par %}
                                        {{ document.uploade_par.nom }} {{ document.uploade_par.prenoms }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ document.date_upload|date:"d/m/Y" }}</td>
                                    <td>
                                        <a href="{{ document.fichier.url }}" class="btn btn-sm btn-primary"
                                           target="_blank" title="Télécharger">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <a href="{% url 'gestion_temps_activite:document_delete' pk=document.pk %}"
                                           class="btn btn-sm btn-danger" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-file fa-3x mb-3"></i>
                            <p>Aucun document pour cette tâche</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-comments"></i> Discussions
                            <span class="badge badge-primary badge-pill ml-2">{{ commentaires|length }}</span>
                            {% if peut_voir_commentaires_prives %}
                            <span class="badge badge-info badge-pill ml-2"><i class="fas fa-users"></i> Vue Équipe</span>
                            {% endif %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Information sur la visibilité -->
                        {% if peut_voir_commentaires_prives and details_visibilite %}
                        <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>Visibilité étendue activée :</strong>
                            Vous pouvez voir tous les commentaires car :
                            <ul class="mb-0 mt-1">
                                {% for detail in details_visibilite %}
                                <li>{{ detail }}</li>
                                {% endfor %}
                            </ul>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endif %}
                        {% if user.is_authenticated and user.employe %}
                        {% if form_commentaire %}
                        <div class="mb-4">
                            <form method="post"
                                  action="{% url 'gestion_temps_activite:commentaire_ajouter' tache_pk=tache.pk %}"
                                  class="commentaire-form" id="commentaire-form">
                                {% csrf_token %}
                                <div class="form-group">
                                    <div class="media">
                                        <img src="{{ user.employe.get_photo_url }}" class="mr-3 rounded-circle" alt="{{ user.employe.nom }}" width="40" height="40">


                                        <div class="media-body">
                                            {{ form_commentaire.contenu }}

                                            {% if form_commentaire.contenu.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form_commentaire.contenu.errors }}
                                            </div>
                                            {% endif %}

                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-paper-plane"></i> Commenter
                                                </button>
                                            </div>
                                        </div>



                                    </div>
                                </div>
                            </form>
                        </div>
                        {% else %}
                        <!-- ✅ Message si pas de permission -->
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Vous ne pouvez pas commenter sur cette tâche</strong>
                            <p class="mb-0 mt-2 small">
                                Vous devez être :
                            </p>
                            <ul class="small mb-0">
                                <li>Assigné à cette tâche</li>
                                <li>Chef du projet</li>
                                <li>Membre de la même équipe que l'assigné</li>
                                <li>Manager du département</li>
                                <li>RH ou Administrateur</li>
                            </ul>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="alert alert-info">
                            Vous devez être connecté en tant qu'employé pour voir et ajouter des commentaires.
                        </div>
                        {% endif %}

                        <!-- Liste des commentaires -->
                        {% if commentaires %}
                        <div class="commentaires-list" id="commentaires-section">
                            {% for commentaire in commentaires %}
                            <div class="commentaire mb-4 {% if commentaire.prive %}commentaire-prive border-left-3 border-left-warning{% endif %}"
                                 id="commentaire-{{ commentaire.id }}">
                                <div class="media">
                                    <img src="{{ commentaire.employe.get_photo_url }}"
                                         class="mr-3 rounded-circle"
                                         alt="{{ commentaire.employe.nom }}"
                                         width="40" height="40">
                                    <div class="media-body">
                                        <div class="commentaire-header d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mt-0 mb-1">
                                                    {{ commentaire.employe.nom }} {{ commentaire.employe.prenoms }}
                                                    {% if commentaire.prive %}
                                                    <span class="badge badge-warning badge-pill ml-1">
                                                <i class="fas fa-lock"></i> Privé
                                            </span>
                                                    {% else %}
                                                    <span class="badge badge-light badge-pill ml-1">
                                                <i class="fas fa-globe"></i> Public
                                            </span>
                                                    {% endif %}
                                                    {% if commentaire.employe == tache.assignee %}
                                                    <span class="badge badge-info badge-pill ml-1">
                                                Assigné
                                            </span>
                                                    {% endif %}
                                                    {% if commentaire.employe == tache.projet.chef_projet %}
                                                    <span class="badge badge-primary badge-pill ml-1">
                                                Chef Projet
                                            </span>
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="far fa-clock"></i> {{ commentaire.get_temps_ecoule }}
                                                    {% if commentaire.edite %}
                                                    <span class="ml-2">
                                                <i class="fas fa-edit"></i> modifié
                                            </span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <!-- Dropdown actions commentaire - VERSION AVEC MODALES -->
                                            <!-- Dropdown Bootstrap 4 -->
                                            {% if commentaire.peut_modifier_par or commentaire.peut_supprimer_par %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-link text-muted" type="button" id="dropdownMenuComment{{ commentaire.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuComment{{ commentaire.id }}">
                                                {% if commentaire.peut_modifier_par %}
                                                <a class="dropdown-item" href="javascript:void(0);" onclick="ouvrirModalModifier('{{ commentaire.id }}', `{{ commentaire.contenu|escapejs }}`); return false;">
                                                    <i class="fas fa-edit text-primary"></i> Modifier
                                                </a>
                                                {% endif %}

                                                {% if commentaire.peut_supprimer_par %}
                                                <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="ouvrirModalSupprimer('{{ commentaire.id }}', `{{ commentaire.contenu|escapejs }}`, {{ commentaire.reponses_visibles|length }}); return false;">
                                                    <i class="fas fa-trash"></i> Supprimer
                                                </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="commentaire-contenu mt-2">
                                        {{ commentaire.contenu|linebreaks }}
                                    </div>

                                    <!-- Réponses -->

                                        {% if commentaire.reponses_visibles %}
                                        <div class="reponses ml-5 mt-3">
                                            {% for reponse in commentaire.reponses_visibles %}
                                            <div class="reponse mb-3 {% if reponse.prive %}border-left-3 border-left-warning pl-2{% endif %}">
                                                <div class="media">
                                                    <img src="{{ reponse.employe.get_photo_url }}"
                                                         class="mr-2 rounded-circle"
                                                         alt="{{ reponse.employe.nom }}"
                                                         width="30" height="30">
                                                    <div class="media-body">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div>
                                                                <strong class="small">
                                                                    {% if reponse.employe.historique_actif %}
                                                                    {{ reponse.employe.historique_actif.nom }} {{ reponse.employe.historique_actif.prenoms }}
                                                                    {% else %}
                                                                    {{ reponse.employe.nom }} {{ reponse.employe.prenoms }}
                                                                    {% endif %}
                                                                </strong>
                                                                {% if reponse.prive %}
                                                                <span class="badge badge-warning badge-pill ml-1">
                                                                    <i class="fas fa-lock fa-xs"></i>
                                                                </span>
                                                                {% endif %}
                                                                <br>
                                                                <small class="text-muted">
                                                                    <i class="far fa-clock"></i> {{ reponse.get_temps_ecoule }}
                                                                    {% if reponse.edite %}
                                                                    <span class="ml-2">
                                                                        <i class="fas fa-edit"></i> modifié
                                                                    </span>
                                                                    {% endif %}
                                                                </small>
                                                            </div>

                                                            <!-- ✅ AJOUT : Dropdown actions pour les réponses -->
                                                            {% if reponse.peut_modifier_par or reponse.peut_supprimer_par %}
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-link text-muted p-0"
                                                                        type="button"
                                                                        id="dropdownMenuReponse{{ reponse.id }}"
                                                                        data-toggle="dropdown"
                                                                        aria-haspopup="true"
                                                                        aria-expanded="false">
                                                                    <i class="fas fa-ellipsis-v"></i>
                                                                </button>
                                                                <div class="dropdown-menu dropdown-menu-right"
                                                                     aria-labelledby="dropdownMenuReponse{{ reponse.id }}">

                                                                    {% if reponse.peut_modifier_par %}
                                                                    <a class="dropdown-item"
                                                                       href="javascript:void(0);"
                                                                       onclick="ouvrirModalModifier('{{ reponse.id }}', `{{ reponse.contenu|escapejs }}`); return false;">
                                                                        <i class="fas fa-edit text-primary"></i>
                                                                        Modifier
                                                                    </a>
                                                                    {% endif %}

                                                                    {% if reponse.peut_supprimer_par %}
                                                                    <a class="dropdown-item text-danger"
                                                                       href="javascript:void(0);"
                                                                       onclick="ouvrirModalSupprimer('{{ reponse.id }}', `{{ reponse.contenu|escapejs }}`, 0); return false;">
                                                                        <i class="fas fa-trash"></i> Supprimer
                                                                    </a>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            <!-- FIN Dropdown actions -->
                                                        </div>
                                                        <div class="mt-1">
                                                            {{ reponse.contenu|linebreaks }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                    <!-- Bouton Répondre -->
                                        {% if user.employe %}
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-link p-0"
                                                    onclick="ouvrirModalRepondre('{{ commentaire.id }}', '{{ commentaire.employe.historique_actif.nom|default:commentaire.employe.nom }} {{ commentaire.employe.historique_actif.prenoms|default:commentaire.employe.prenoms }}')">
                                                <i class="fas fa-reply"></i> Répondre
                                            </button>
                                        </div>
                                        {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="far fa-comments fa-3x mb-3"></i>
                        <p>Aucune discussion pour cette tâche</p>
                        <p class="small">Soyez le premier à commenter !</p>
                    </div>
                    {% endif %}
                </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extramodals %}
<!-- ==================== MODALES BOOTSTRAP 4 ==================== -->

<!-- Modal Modifier Commentaire -->
<div class="modal fade" id="modalModifierCommentaire" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-modal text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Modifier le commentaire
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="formModifierCommentaire" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="commentaire_id_modifier">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Le commentaire sera marqué comme "modifié"
                    </div>
                    <div class="form-group">
                        <label for="commentaire_contenu_modifier">
                            <i class="fas fa-comment"></i> Contenu
                        </label>
                        <textarea class="form-control" id="commentaire_contenu_modifier" name="contenu" rows="5" maxlength="1000" required></textarea>
                        <small class="form-text text-muted">
                            <span id="caracteres_restants">1000</span> caractères restants
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Supprimer Commentaire -->
<div class="modal fade" id="modalSupprimerCommentaire" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmer la suppression
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="formSupprimerCommentaire" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="commentaire_id_supprimer">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Attention !</strong> Cette action est irréversible.
                    </div>
                    <p>Êtes-vous sûr de vouloir supprimer ce commentaire ?</p>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0" id="commentaire_apercu_suppression"></p>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-warning small" id="avertissement_reponses" style="display:none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Note :</strong> Les réponses seront également supprimées.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Oui, supprimer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Répondre à un Commentaire -->
<div class="modal fade" id="modalRepondreCommentaire" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-modal text-white">
                <h5 class="modal-title">
                    <i class="fas fa-reply"></i> Répondre au commentaire
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="formRepondreCommentaire" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="commentaire_parent_id">
                    <div class="alert alert-light">
                        <i class="fas fa-info-circle"></i>
                        Vous répondez au commentaire de <strong id="auteur_commentaire_parent"></strong>
                    </div>
                    <div class="form-group">
                        <label for="reponse_contenu">
                            <i class="fas fa-comment"></i> Votre réponse
                        </label>
                        <textarea class="form-control" id="reponse_contenu" name="contenu" rows="4" maxlength="1000" placeholder="Écrivez votre réponse..." required></textarea>
                        <small class="form-text text-muted">
                            <span id="reponse_caracteres_restants">1000</span> caractères restants
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Envoyer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extrascript %}

<script src="{% static 'assets/js/gta/gestion_tache.js' %}"></script>
<script src="{% static 'assets/js/gta/gestion_commentaires.js' %}"></script>
<script src="{% static 'assets/js/gta/modal-commentaires.js' %}"></script>
{% endblock %}