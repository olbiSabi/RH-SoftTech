<!-- gestion_temps_activite/templates/gestion_temps_activite/activite_liste.html -->
{% extends 'base/baseSansMatricule.html' %}
{% load static %}

{% block extrastylet %}
<link rel="stylesheet" href="{% static 'assets/css/gta/gestion_activite.css' %}">
{% endblock %}

{% block pageContent %}
<section class="content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h1 class="h3 mb-2 text-gray-800">
                    <i class="fas fa-list-check"></i> Types d'Activités
                </h1>
            </div>
            <div class="col-md-6 text-right">
                <a href="{% url 'gestion_temps_activite:activite_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nouvelle Activité
                </a>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Filtres et recherche -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Filtres et Recherche</h6>
            </div>
            <div class="card-body">
                <form method="get" class="form-inline">
                    <div class="form-group mr-2 mb-2">
                        <input type="text" name="search" class="form-control search-input"
                               placeholder="Rechercher..." value="{{ search_query }}">
                    </div>
                    <div class="form-group mr-2 mb-2">
                        <select name="facturable" class="form-control">
                            <option value="">Toutes les activités</option>
                            <option value="True" {% if facturable_filter == 'True' %}selected{% endif %}>Facturable</option>
                            <option value="False" {% if facturable_filter == 'False' %}selected{% endif %}>Non facturable</option>
                        </select>
                    </div>
                    <div class="form-group mr-2 mb-2">
                        <select name="actif" class="form-control">
                            <option value="">Tous les statuts</option>
                            <option value="True" {% if actif_filter == 'True' %}selected{% endif %}>Actif</option>
                            <option value="False" {% if actif_filter == 'False' %}selected{% endif %}>Inactif</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary mb-2">
                        <i class="fas fa-search"></i> Rechercher
                    </button>
                    <a href="{% url 'gestion_temps_activite:activite_liste' %}" class="btn btn-secondary ml-2 mb-2">
                        <i class="fas fa-redo"></i> Réinitialiser
                    </a>
                </form>
            </div>
        </div>

        <!-- Info sur les activités -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Les types d'activités permettent de catégoriser le temps passé sur les tâches.
                    Chaque activité peut être facturable ou non, avec un taux horaire par défaut.
                </div>
            </div>
        </div>

        <!-- Liste des activités -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Liste des Types d'Activités</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover activite-table" id="dataTable">
                        <thead class="thead-light">
                            <tr>
                                <th width="10%">Code</th>
                                <th width="20%">Libellé</th>
                                <th width="25%">Description</th>
                                <th width="10%">Taux Horaire</th>
                                <th width="10%">Facturable</th>
                                <th width="10%">Période</th>
                                <th width="10%">Statut</th>
                                <th width="5%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activite in activites %}
                            <tr class="{% if not activite.actif or not activite.est_en_vigueur %}activite-row-inactive{% endif %}">
                                <td><strong class="code-activite">{{ activite.code_activite }}</strong></td>
                                <td>
                                    <strong>{{ activite.libelle }}</strong>
                                    {% if activite.nombre_imputations > 0 %}
                                    <br><small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ activite.nombre_imputations }} imputation(s)
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if activite.description %}
                                    <small>{{ activite.description|truncatewords:15 }}</small>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if activite.taux_horaire_defaut %}
                                    <strong class="text-success">{{ activite.taux_horaire_defaut|floatformat:0 }} FCFA</strong>
                                    {% else %}
                                    <span class="text-muted">Non défini</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if activite.facturable %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-check"></i> Facturable
                                    </span>
                                    {% else %}
                                    <span class="badge badge-secondary">
                                        <i class="fas fa-times"></i> Non facturable
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        <strong>Début:</strong> {{ activite.date_debut|date:"d/m/Y" }}<br>
                                        {% if activite.date_fin %}
                                        <strong>Fin:</strong> {{ activite.date_fin|date:"d/m/Y" }}
                                        {% else %}
                                        <strong>Fin:</strong> <span class="text-muted">Illimitée</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% with statut=activite.get_statut_display %}
                                    {% if "Actif" in statut and "jusqu'au" not in statut %}
                                    <span class="badge badge-success">Actif</span>
                                    {% elif "Actif (jusqu'au" in statut %}
                                    <span class="badge badge-warning" title="{{ statut }}">Actif (limité)</span>
                                    {% elif "À venir" in statut %}
                                    <span class="badge badge-info" title="{{ statut }}">À venir</span>
                                    {% elif "Expiré" in statut %}
                                    <span class="badge badge-danger" title="{{ statut }}">Expiré</span>
                                    {% else %}
                                    <span class="badge badge-secondary" title="{{ statut }}">Inactif</span>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'gestion_temps_activite:activite_update' pk=activite.pk %}"
                                           class="btn btn-sm btn-warning" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'gestion_temps_activite:activite_delete' pk=activite.pk %}"
                                           class="btn btn-sm btn-danger" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    Aucun type d'activité trouvé
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Légende des statuts -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-info-circle"></i> Légende des Statuts
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <span class="badge badge-success">Actif</span> - Activité utilisable sans limite de temps
                            </div>
                            <div class="col-md-3 mb-2">
                                <span class="badge badge-warning">Actif (limité)</span> - Activité avec date d'expiration définie
                            </div>
                            <div class="col-md-3 mb-2">
                                <span class="badge badge-info">À venir</span> - Activité pas encore active (date de début future)
                            </div>
                            <div class="col-md-3 mb-2">
                                <span class="badge badge-danger">Expiré</span> - Activité dont la date de fin est passée
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb"></i>
                                    <strong>Note :</strong> Une activité doit être "Actif" ET dans sa période de validité pour être utilisable dans les imputations de temps.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extrascript %}
<script src="{% static 'assets/js/gta/gestion_activite.js' %}"></script>
{% endblock %}